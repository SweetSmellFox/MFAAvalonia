<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:other="clr-namespace:MFAAvalonia.ViewModels.Other"
             xmlns:suki="https://github.com/kikipoulet/SukiUI"
             xmlns:avalonia1="clr-namespace:FluentIcons.Avalonia;assembly=FluentIcons.Avalonia"
             xmlns:fluent="clr-namespace:FluentIcons.Avalonia.Fluent;assembly=FluentIcons.Avalonia.Fluent"
             xmlns:helper="clr-namespace:MFAAvalonia.Helper"
             xmlns:markup="https://codewf.com"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="50"
             x:Class="MFAAvalonia.Views.UserControls.InstanceTabBar"
             x:DataType="other:InstanceTabBarViewModel">
    
    <UserControl.Styles>
        <!-- GlassCard 标签背景：默认隐藏 -->
        <Style Selector="Panel.TabContainer suki|GlassCard.TabGlass">
            <Setter Property="IsVisible" Value="False"/>
        </Style>
        <!-- 悬停背景：默认隐藏 -->
        <Style Selector="Panel.TabContainer Border.TabHoverBg">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="Background" Duration="0:0:0.15"/>
                </Transitions>
            </Setter>
        </Style>

        
        <!-- 标签间分隔线 -->
        <Style Selector="Panel.TabContainer Border.TabSeparator">
            <Setter Property="Opacity" Value="0.5"/>
        </Style>
        
        <!-- 悬停：显示浅色背景 -->
        <Style Selector="Panel.TabContainer:pointerover Border.TabHoverBg">
            <Setter Property="Background" Value="{DynamicResource SukiCardBackground}"/>
            <Setter Property="Opacity" Value="0.3"/>
        </Style>

        
        <!-- 激活：显示 GlassCard，隐藏悬停背景 -->
        <Style Selector="Panel.TabContainer.Active suki|GlassCard.TabGlass">
            <Setter Property="IsVisible" Value="True"/>
        </Style>
        <Style Selector="Panel.TabContainer.Active Border.TabHoverBg">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="Panel.TabContainer.Active:pointerover Border.TabHoverBg">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        
        <!-- 激活标签底部指示线：默认隐藏 -->
        <Style Selector="Panel.TabContainer Border.TabActiveIndicator">
            <Setter Property="IsVisible" Value="False"/>
        </Style>
        <Style Selector="Panel.TabContainer.Active Border.TabActiveIndicator">
            <Setter Property="IsVisible" Value="True"/>
        </Style>

        
        <!-- 激活标签文字加粗 -->
        <Style Selector="Panel.TabContainer.Active TextBlock.TabText">
            <Setter Property="FontWeight" Value="SemiBold"/>
        </Style>
        
        <Style Selector="Ellipse.PulseAnimation">
            <Style.Animations>
                <Animation Duration="0:0:1.5" IterationCount="INFINITE" Easing="CubicEaseInOut">
                    <KeyFrame Cue="0%">
                        <Setter Property="Opacity" Value="1" />
                    </KeyFrame>
                    <KeyFrame Cue="50%">
                        <Setter Property="Opacity" Value="0.4" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="Opacity" Value="1" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
        
        <!-- 展开按钮旋转动画 -->
        <Style Selector="Button.DropdownToggle fluent|FluentIcon">
            <Setter Property="RenderTransform" Value="rotate(0deg)"/>
            <Setter Property="Transitions">
                <Transitions>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2"/>
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="Button.DropdownToggle.Open fluent|FluentIcon">
            <Setter Property="RenderTransform" Value="rotate(180deg)"/>
        </Style>
        
        <!-- 下拉列表项样式 -->
        <Style Selector="Border.DropdownItem">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Padding" Value="5,0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Margin" Value="3,0,3,3"/>
        </Style>
        <Style Selector="Border.DropdownItem:pointerover">
            <Setter Property="Background" Value="{DynamicResource SukiLightBorderBrush}"/>
        </Style>
        <Style Selector="Border.DropdownItem.Selected">
            <Setter Property="Background" Value="{DynamicResource SukiLightBorderBrush}"/>
        </Style>
        <Style Selector="Border.DropdownItem.Selected:pointerover">
            <Setter Property="Background" Value="{DynamicResource SukiLightBorderBrush}"/>
        </Style>
        <Style Selector="Border.DropdownItem Border.SelectedIndicator">
            <Setter Property="IsVisible" Value="False"/>
        </Style>
        <Style Selector="Border.DropdownItem.Selected Border.SelectedIndicator">
            <Setter Property="IsVisible" Value="True"/>
        </Style>
    </UserControl.Styles>

    <Grid ColumnDefinitions="*,Auto,Auto">
        <ScrollViewer x:Name="TabScrollViewer" 
                      HorizontalScrollBarVisibility="Hidden" 
                      VerticalScrollBarVisibility="Disabled"
                      ClipToBounds="False">
            <ItemsControl ItemsSource="{Binding Tabs}" ClipToBounds="False">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel x:Name="TabStackPanel" Orientation="Horizontal" Spacing="0" ClipToBounds="False"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Panel Classes="TabContainer"
                               Classes.Active="{Binding IsActive}"
                               ClipToBounds="False"
                               Margin="0,4,0,0"
                               Cursor="Hand"
                               PointerEntered="OnTabPointerEntered"
                               PointerExited="OnTabPointerExited">
                            
                            <!-- 激活标签背景：GlassCard（跟随 BackgroundStyle 变化） -->
                            <suki:GlassCard Classes="TabGlass"
                                            CornerRadius="8,8,0,0"
                                            IsAnimated="False"
                                            BorderThickness="0"
                                            Padding="0"/>
                            
                            <!-- 悬停标签背景 -->
                            <Border Classes="TabHoverBg"
                                    CornerRadius="8,8,0,0"
                                    IsHitTestVisible="False"/>
                            
                            <!-- 右侧分隔线 -->
                            <Border Classes="TabSeparator"
                                    Width="1" Height="16"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Center"
                                    Background="{DynamicResource SukiText}"
                                    IsHitTestVisible="False"/>
                            
                            <!-- 激活标签底部指示线 -->
                            <Border Classes="TabActiveIndicator"
                                    Height="2"
                                    Margin="6,0"
                                    VerticalAlignment="Bottom"
                                    CornerRadius="1"
                                    Background="{DynamicResource SukiPrimaryColor}"
                                    IsHitTestVisible="False"/>
                            
                            <!-- 内容层 -->
                            <Border Background="Transparent"
                                    Padding="15,7"
                                    CornerRadius="8,8,0,0"
                                    PointerPressed="OnTabPointerPressed">
                                <Border.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="重命名"
                                                  Command="{Binding $parent[UserControl].((other:InstanceTabBarViewModel)DataContext).RenameInstanceCommand}"
                                                  CommandParameter="{Binding .}"/>
                                        <MenuItem Header="关闭"
                                                  Command="{Binding $parent[UserControl].((other:InstanceTabBarViewModel)DataContext).CloseInstanceCommand}"
                                                  CommandParameter="{Binding .}"/>
                                    </ContextMenu>
                                </Border.ContextMenu>
                                
                                <StackPanel Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                                    <TextBlock Classes="TabText"
                                               Text="{Binding Name}"
                                               VerticalAlignment="Center"/>
                                    <Ellipse Width="8" Height="8"
                                             Fill="LimeGreen"
                                             IsVisible="{Binding IsRunning}"
                                             VerticalAlignment="Center"
                                             Classes="PulseAnimation"/>
                                </StackPanel>
                            </Border>

                        </Panel>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- 展开按钮 -->
        <Button x:Name="DropdownButton"
                Grid.Column="1"
                Classes="Basic DropdownToggle"
                Classes.Open="{Binding IsDropdownOpen}"
                Margin="8,0,0,0"
                Command="{Binding ToggleDropdownCommand}"
                ToolTip.Tip="选择实例">
            <fluent:FluentIcon Icon="ChevronDown" IconSize="Size16" />
        </Button>
        
        <!-- 下拉框 Popup -->
        <Popup x:Name="InstanceDropdown"
               IsOpen="{Binding IsDropdownOpen, Mode=TwoWay}"
               PlacementTarget="{Binding #DropdownButton}"
               Placement="Bottom"
               IsLightDismissEnabled="True"
               HorizontalOffset="-100"
               InheritsTransform="True">
            <Border Padding="5,10,5,5">
                <Border Background="{DynamicResource SukiPopupBackground}"
                        BorderBrush="{DynamicResource SukiMenuBorderBrush}"
                        BorderThickness="1"
                        BoxShadow="{DynamicResource SukiSmallPopupShadow}"
                        CornerRadius="{DynamicResource SmallCornerRadius}"
                        MinWidth="150"
                        MaxWidth="280">
                    <Grid Background="{DynamicResource PopupGradientBrush}" RowDefinitions="Auto,*">
                        <suki:GlassCard Grid.RowSpan="2" Margin="-1"
                                        CornerRadius="{DynamicResource SmallCornerRadius}"
                                        IsAnimated="False" />
                        <TextBox Grid.Row="0" Margin="4"
                                 Text="{Binding SearchText, Mode=TwoWay}"
                                 Watermark="{markup:I18n {x:Static helper:LangKeys.Search}}">
                            <TextBox.InnerRightContent>
                                <fluent:FluentIcon Margin="0,-2,0,0" VerticalAlignment="Center"
                                                   Foreground="{DynamicResource SukiDisabledText}"
                                                   Icon="Search" IconSize="Size16" />
                            </TextBox.InnerRightContent>
                        </TextBox>
                        <ScrollViewer Grid.Row="1" MaxHeight="280" VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding FilteredTabs}" Margin="0,3,0,3">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Classes="DropdownItem"
                                                Classes.Selected="{Binding IsActive}"
                                                PointerPressed="OnDropdownItemPressed">
                                            <Panel>
                                                <Border Classes="SelectedIndicator"
                                                        Width="3" Height="16"
                                                        CornerRadius="1.5"
                                                        Background="{DynamicResource SukiPrimaryColor}"
                                                        Margin="-5,0,0,0"
                                                        HorizontalAlignment="Left"
                                                        VerticalAlignment="Center"/>
                                                <StackPanel Orientation="Horizontal" Spacing="8"
                                                            Margin="5,5,2,5">
                                                    <TextBlock Text="{Binding Name}"
                                                               Foreground="{DynamicResource SukiText}"
                                                               VerticalAlignment="Center"
                                                               MaxWidth="200"
                                                               TextTrimming="CharacterEllipsis"
                                                               ToolTip.Tip="{Binding Name}"/>
                                                    <Ellipse Width="6" Height="6"
                                                             Fill="LimeGreen"
                                                             IsVisible="{Binding IsRunning}"
                                                             VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Panel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </Border>
            </Border>
        </Popup>

        <!-- + 按钮 -->
        <Button Grid.Column="2"
                Classes="Basic"
                Margin="8,0,0,0"
                Command="{Binding AddInstanceCommand}"
                ToolTip.Tip="新建实例">
             <fluent:FluentIcon Icon="Add" IconSize="Size16" />
        </Button>
    </Grid>
</UserControl>
