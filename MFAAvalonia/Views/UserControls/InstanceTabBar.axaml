<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:other="clr-namespace:MFAAvalonia.ViewModels.Other"
             xmlns:controls="clr-namespace:MFAAvalonia.Controls"
             xmlns:suki="https://github.com/kikipoulet/SukiUI"
             xmlns:fluent="clr-namespace:FluentIcons.Avalonia.Fluent;assembly=FluentIcons.Avalonia.Fluent"
             xmlns:helper="clr-namespace:MFAAvalonia.Helper"
             xmlns:markup="https://codewf.com"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="MFAAvalonia.Views.UserControls.InstanceTabBar"
             x:DataType="other:InstanceTabBarViewModel">

    <UserControl.Styles>
        <!-- 运行指示器脉冲动画 -->
        <Style Selector="Ellipse.PulseAnimation">
            <Style.Animations>
                <Animation Duration="0:0:1.5" IterationCount="INFINITE" Easing="CubicEaseInOut">
                    <KeyFrame Cue="0%">
                        <Setter Property="Opacity" Value="1" />
                    </KeyFrame>
                    <KeyFrame Cue="50%">
                        <Setter Property="Opacity" Value="0.4" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="Opacity" Value="1" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <!-- 展开按钮旋转动画 -->
        <Style Selector="Button.DropdownToggle fluent|FluentIcon">
            <Setter Property="RenderTransform" Value="rotate(0deg)" />
            <Setter Property="Transitions">
                <Transitions>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2" />
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="Button.DropdownToggle.Open fluent|FluentIcon">
            <Setter Property="RenderTransform" Value="rotate(180deg)" />
        </Style>

        <!-- 下拉列表项样式 -->
        <Style Selector="Border.DropdownItem">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Padding" Value="5,0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Margin" Value="3,0,3,3" />
        </Style>
        <Style Selector="Border.DropdownItem:pointerover">
            <Setter Property="Background" Value="{DynamicResource SukiLightBorderBrush}" />
        </Style>
        <Style Selector="Border.DropdownItem.Selected">
            <Setter Property="Background" Value="{DynamicResource SukiLightBorderBrush}" />
        </Style>
        <Style Selector="Border.DropdownItem.Selected:pointerover">
            <Setter Property="Background" Value="{DynamicResource SukiLightBorderBrush}" />
        </Style>
        <Style Selector="Border.DropdownItem Border.SelectedIndicator">
            <Setter Property="IsVisible" Value="False" />
        </Style>
        <Style Selector="Border.DropdownItem.Selected Border.SelectedIndicator">
            <Setter Property="IsVisible" Value="True" />
        </Style>
        <!-- 下拉关闭按钮样式 -->
        <Style Selector="Button.DropdownCloseBtn">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Opacity" Value="0.5" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>
        <Style Selector="Button.DropdownCloseBtn:pointerover">
            <Setter Property="Opacity" Value="1" />
        </Style>
        <!-- + 按钮 tooltip -->
        <Style Selector="controls|InstanceTabsControl /template/ Button#PART_AddItemButton">
            <Setter Property="ToolTip.Tip" Value="{markup:I18n {x:Static helper:LangKeys.InstanceAddTooltip}}" />
        </Style>
        <!-- 预设菜单项按钮样式（与 DropdownItem 保持一致） -->
        <Style Selector="Button.PresetMenuItem">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="5,0" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Margin" Value="3,0,3,3" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="HorizontalAlignment" Value="Stretch" />
            <Setter Property="HorizontalContentAlignment" Value="Left" />
        </Style>
        <Style Selector="Button.PresetMenuItem:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource SukiLightBorderBrush}" />
            <Setter Property="CornerRadius" Value="6" />
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto,*">
        <!-- Row 0: 标签栏 = [展开按钮(固定左)] [标签页+添加按钮] -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,*">
            <!-- TabBarBackground 铺满整个标签栏（包括下拉按钮区域），选中标签区域会被 Clip 挖掉 -->
            <Border x:Name="TabBarBackgroundBorder"
                    Grid.ColumnSpan="2"
                    Background="{DynamicResource TabBarBackground}" />

            <!-- 展开按钮（固定最左边） -->
            <Button Grid.Column="0"
                    x:Name="DropdownButton"
                    Classes="DropdownToggle"
                    Classes.Open="{Binding IsDropdownOpen}"
                    Theme="{StaticResource DropdownToggleButton}"
                    VerticalAlignment="Center"
                    Margin="3,2,4,2"
                    Command="{Binding ToggleDropdownCommand}"
                    ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.InstanceSelectTooltip}}">
                <fluent:FluentIcon Icon="ChevronDown" IconSize="Size16" />
            </Button>

            <!-- 标签页控件（动态宽度 + 右侧跟随 + 按钮） -->
            <controls:InstanceTabsControl Grid.Column="1"
                                          x:Name="TabsControl"
                                          Margin="0,4,0,0"
                                          ItemsSource="{Binding Tabs}"
                                          SelectedItem="{Binding ActiveTab, Mode=TwoWay}"
                                          AddItemCommand="{Binding AddInstanceCommand}"
                                          CloseItemCommand="{Binding CloseInstanceCommand}"
                                          TabItemWidth="200"
                                          ShowDefaultAddButton="True">
                <controls:InstanceTabsControl.ItemTemplate>
                    <DataTemplate x:DataType="other:InstanceTabViewModel">
                        <StackPanel Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                            <Ellipse Width="7" Height="7"
                                     Fill="LimeGreen"
                                     IsVisible="{Binding IsRunning}"
                                     VerticalAlignment="Center"
                                     Classes="PulseAnimation" />
                            <TextBlock Text="{Binding Name}"
                                       VerticalAlignment="Center"
                                       TextTrimming="CharacterEllipsis" />
                        </StackPanel>
                    </DataTemplate>
                </controls:InstanceTabsControl.ItemTemplate>
            </controls:InstanceTabsControl>
        </Grid>

        <!-- Row 1: 内容区域 -->
        <ContentControl Grid.Row="1"
                        Content="{Binding ActiveTab.View}"
                        Margin="0" />
        <!-- 预设菜单 Popup（有预设时点击+号弹出，PlacementTarget 由 code-behind 动态设为 PART_AddItemButton） -->
        <Popup x:Name="PresetMenuPopup"
               IsOpen="{Binding IsAddMenuOpen, Mode=TwoWay}"
               Placement="Bottom"
               IsLightDismissEnabled="True"
               InheritsTransform="True">
            <Border Padding="5,10,5,5">
                <Border Background="{DynamicResource SukiPopupBackground}"
                        BorderBrush="{DynamicResource SukiMenuBorderBrush}"
                        BorderThickness="1"
                        BoxShadow="{DynamicResource SukiSmallPopupShadow}"
                        CornerRadius="{DynamicResource SmallCornerRadius}"
                        MinWidth="160"
                        MaxWidth="280">
                    <Grid Background="{DynamicResource PopupGradientBrush}">
                        <suki:GlassCard Margin="-1"
                                        CornerRadius="{DynamicResource SmallCornerRadius}"
                                        IsAnimated="False" />
                        <StackPanel Margin="0,3,0,3">
                            <!-- 跟随最右侧配置 -->
                            <Button Classes="PresetMenuItem"
                                    Command="{Binding AddInstanceWithPresetCommand}"
                                    CommandParameter="{x:Null}">
                                <TextBlock Text="{markup:I18n {x:Static helper:LangKeys.InstanceAddFollowLast}}"
                                           Foreground="{DynamicResource SukiText}"
                                           Margin="2,5,2,5" />
                            </Button>
                            <Separator Margin="3,3" />
                            <!-- 预设列表 -->
                            <ItemsControl ItemsSource="{Binding InstancePresets}"
                                          HorizontalAlignment="Stretch">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Classes="PresetMenuItem"
                                                Command="{Binding $parent[UserControl].((other:InstanceTabBarViewModel)DataContext).AddInstanceWithPresetCommand}"
                                                CommandParameter="{Binding}">
                                            <TextBlock Text="{Binding Name}"
                                                       Foreground="{DynamicResource SukiText}"
                                                       Margin="2,5,2,5"
                                                       TextTrimming="CharacterEllipsis" />
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Grid>
                </Border>
            </Border>
        </Popup>

        <!-- 下拉框 Popup -->
        <Popup x:Name="InstanceDropdown"
               IsOpen="{Binding IsDropdownOpen, Mode=TwoWay}"
               PlacementTarget="{Binding #DropdownButton}"
               Placement="Bottom"
               IsLightDismissEnabled="True"
               HorizontalOffset="0"
               InheritsTransform="True">
            <Border Padding="5,10,5,5">
                <Border Background="{DynamicResource SukiPopupBackground}"
                        BorderBrush="{DynamicResource SukiMenuBorderBrush}"
                        BorderThickness="1"
                        BoxShadow="{DynamicResource SukiSmallPopupShadow}"
                        CornerRadius="{DynamicResource SmallCornerRadius}"
                        MinWidth="150"
                        MaxWidth="280">
                    <Grid Background="{DynamicResource PopupGradientBrush}" RowDefinitions="Auto,*">
                        <suki:GlassCard Grid.RowSpan="2" Margin="-1"
                                        CornerRadius="{DynamicResource SmallCornerRadius}"
                                        IsAnimated="False" />
                        <TextBox Grid.Row="0" Margin="4"
                                 Text="{Binding SearchText, Mode=TwoWay}"
                                 Watermark="{markup:I18n {x:Static helper:LangKeys.Search}}">
                            <TextBox.InnerRightContent>
                                <fluent:FluentIcon Margin="0,-2,0,0" VerticalAlignment="Center"
                                                   Foreground="{DynamicResource SukiDisabledText}"
                                                   Icon="Search" IconSize="Size16" />
                            </TextBox.InnerRightContent>
                        </TextBox>
                        <ScrollViewer Grid.Row="1" MaxHeight="280" VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding FilteredTabs}" Margin="0,3,0,3">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Classes="DropdownItem"
                                                Classes.Selected="{Binding IsActive}"
                                                PointerPressed="OnDropdownItemPressed">
                                            <Grid ColumnDefinitions="Auto,*,Auto">
                                                <Border Grid.Column="0"
                                                        Classes="SelectedIndicator"
                                                        Width="3" Height="16"
                                                        CornerRadius="1.5"
                                                        Background="{DynamicResource SukiPrimaryColor}"
                                                        Margin="0,0,4,0"
                                                        VerticalAlignment="Center" />
                                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8"
                                                            Margin="2,5,2,5">
                                                    <Ellipse Width="6" Height="6"
                                                             Fill="LimeGreen"
                                                             IsVisible="{Binding IsRunning}"
                                                             VerticalAlignment="Center"
                                                             Classes="PulseAnimation" />
                                                    <TextBlock Text="{Binding Name}"
                                                               Foreground="{DynamicResource SukiText}"
                                                               VerticalAlignment="Center"
                                                               MaxWidth="170"
                                                               TextTrimming="CharacterEllipsis"
                                                               ToolTip.Tip="{Binding Name}" />
                                                </StackPanel>
                                                <Button Grid.Column="2"
                                                        Classes="DropdownCloseBtn"
                                                        Width="20" Height="20"
                                                        Padding="0"
                                                        Margin="2,0,0,0"
                                                        VerticalAlignment="Center"
                                                        Click="OnDropdownCloseClicked"
                                                        ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.ButtonClose}}">
                                                    <fluent:FluentIcon Icon="Dismiss" IconSize="Size12" />
                                                </Button>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </Border>
            </Border>
        </Popup>
    </Grid>
</UserControl>