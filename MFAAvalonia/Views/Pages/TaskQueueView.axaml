<?xml version="1.0" encoding="UTF-8"?>

<UserControl d:DesignHeight="450"
             d:DesignWidth="800"
             mc:Ignorable="d"
             x:Class="MFAAvalonia.Views.Pages.TaskQueueView"
             x:DataType="pages:TaskQueueViewModel"
             xmlns="https://github.com/avaloniaui"
             xmlns:System="clr-namespace:System;assembly=System.Runtime"
             xmlns:binding="clr-namespace:MaaFramework.Binding;assembly=MaaFramework.Binding"
             xmlns:calcBinding="clr-namespace:CalcBinding;assembly=CalcBindingAva"
             xmlns:converters="clr-namespace:MFAAvalonia.Helper.Converters"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:ex="clr-namespace:MFAAvalonia.Extensions"
             xmlns:valueType="clr-namespace:MFAAvalonia.Helper.ValueType"
             xmlns:maa="clr-namespace:MFAAvalonia.Extensions.MaaFW"
             xmlns:markup="https://codewf.com"
             xmlns:controls="clr-namespace:MFAAvalonia.Views.UserControls"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:mdxaml="https://github.com/whistyun/Markdown.Avalonia"
             xmlns:pages="clr-namespace:MFAAvalonia.ViewModels.Pages"
             xmlns:suki="https://github.com/kikipoulet/SukiUI"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:behaviors="using:Avalonia.Xaml.Interactions.Core"
             xmlns:interaction="using:Avalonia.Xaml.Interactivity"
             xmlns:avalonia="https://github.com/whistyun/Markdown.Avalonia.Tight"
             xmlns:helper="clr-namespace:MFAAvalonia.Helper"
             xmlns:avalonia1="clr-namespace:FluentIcons.Avalonia;assembly=FluentIcons.Avalonia"
             xmlns:fluent="clr-namespace:FluentIcons.Avalonia.Fluent;assembly=FluentIcons.Avalonia.Fluent"
             xmlns:other="clr-namespace:MFAAvalonia.ViewModels.Other">
    <Design.DataContext>
        <pages:TaskQueueViewModel />
    </Design.DataContext>
    <UserControl.Resources>
        <ContextMenu x:Key="TaskMenu">
            <MenuItem IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                      Click="RunSingleTask"
                      Header="{markup:I18n {x:Static helper:LangKeys.RunSingle}}" />
            <MenuItem IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                      Click="RunCheckedFromCurrent"
                      Header="{markup:I18n {x:Static helper:LangKeys.RunCheckedFromCurrent}}" />
            <MenuItem Click="Delete"
                      Header="{markup:I18n {x:Static helper:LangKeys.Delete}}" />
        </ContextMenu>
        <markup:IfConditionConverter x:Key="StatusConditionConverter">
            <markup:IfConditionConverter.True>
                <WrapPanel>
                    <Path Data="{StaticResource StopGeometry}"
                          Fill="{DynamicResource WhiteBrush}"
                          Width="12" Height="12"
                          Stretch="Uniform"
                          VerticalAlignment="Center"
                          HorizontalAlignment="Center" />
                    <TextBlock Margin="5 0 0 0" Text="{markup:I18n {x:Static helper:LangKeys.StopTask}}" />
                </WrapPanel>
            </markup:IfConditionConverter.True>
            <markup:IfConditionConverter.False>
                <WrapPanel>
                    <Path Data="{StaticResource PlayGeometry}"
                          Fill="{DynamicResource WhiteBrush}"
                          Width="12" Height="12"
                          Stretch="Uniform"
                          VerticalAlignment="Center"
                          HorizontalAlignment="Center" />
                    <TextBlock Margin="5 0 0 0" Text="{markup:I18n {x:Static helper:LangKeys.StartTask}}" />
                </WrapPanel>

            </markup:IfConditionConverter.False>
        </markup:IfConditionConverter>
    </UserControl.Resources>
    <UserControl.Styles>
        <!-- 中心绿点脉冲动画 -->
        <Style Selector="Ellipse#LiveStatusDot">
            <Style.Animations>
                <Animation Duration="0:0:1.5" IterationCount="INFINITE" Easing="CubicEaseInOut">
                    <KeyFrame Cue="0%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1" />
                        <Setter Property="Opacity" Value="1" />
                    </KeyFrame>
                    <KeyFrame Cue="50%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1.2" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1.2" />
                        <Setter Property="Opacity" Value="0.8" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1" />
                        <Setter Property="Opacity" Value="1" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <!-- 外圈扩散动画 1 -->
        <Style Selector="Ellipse#PulseRing1">
            <Style.Animations>
                <Animation Duration="0:0:1.5" IterationCount="INFINITE" Easing="CubicEaseOut">
                    <KeyFrame Cue="0%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1" />
                        <Setter Property="Opacity" Value="0.6" />
                        <Setter Property="StrokeThickness" Value="2" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="2.5" />
                        <Setter Property="ScaleTransform.ScaleY" Value="2.5" />
                        <Setter Property="Opacity" Value="0" />
                        <Setter Property="StrokeThickness" Value="0.5" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <!-- 外圈扩散动画 2 (延迟 0.75s) -->
        <Style Selector="Ellipse#PulseRing2">
            <Style.Animations>
                <Animation Duration="0:0:1.5" IterationCount="INFINITE" Easing="CubicEaseOut" Delay="0:0:0.75">
                    <KeyFrame Cue="0%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1" />
                        <Setter Property="Opacity" Value="0.6" />
                        <Setter Property="StrokeThickness" Value="2" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="2.5" />
                        <Setter Property="ScaleTransform.ScaleY" Value="2.5" />
                        <Setter Property="Opacity" Value="0" />
                        <Setter Property="StrokeThickness" Value="0.5" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <!-- Live View 折叠按钮旋转动画 -->
        <Style Selector="avalonia1|FluentIcon#LiveViewToggleIcon">
            <Setter Property="RenderTransformOrigin" Value="50%,50%" />
            <Setter Property="Transitions">
                <Transitions>
                    <DoubleTransition Property="(RotateTransform.Angle)" Duration="0:0:0.25" Easing="CubicEaseInOut" />
                </Transitions>
            </Setter>
        </Style>

        <!-- 展开状态：图标旋转 180 度（箭头朝上） -->
        <Style Selector="suki|GlassCard#LiveViewCard[Tag=Expanded] avalonia1|FluentIcon#LiveViewToggleIcon">
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <RotateTransform Angle="180" />
                </Setter.Value>
            </Setter>
        </Style>

        <Style Selector="Button.PanelToggleButton">
            <Setter Property="RenderTransformOrigin" Value="50%,50%" />
            <Setter Property="Opacity" Value="0.7" />
            <Setter Property="Transitions">
                <Transitions>
                    <DoubleTransition Property="Opacity" Duration="0:0:0.2" />
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2" Easing="CubicEaseOut" />
                </Transitions>
            </Setter>
        </Style>

        <Style Selector="Button.PanelToggleButton:pointerover">
            <Setter Property="Opacity" Value="1" />
            <Setter Property="RenderTransform">
                <ScaleTransform ScaleX="1.1" ScaleY="1.1" />
            </Setter>
        </Style>

        <!-- 折叠时的展开按钮出现动画 -->
        <Style Selector="Button.ExpandButton">
            <Setter Property="RenderTransformOrigin" Value="50%,50%" />
            <Setter Property="Transitions">
                <Transitions>
                    <DoubleTransition Property="Opacity" Duration="0:0:0.3" Easing="CubicEaseOut" />
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.3" Easing="BackEaseOut" />
                </Transitions>
            </Setter>
        </Style>

        <Style Selector="Button.ExpandButton:pointerover">
            <Setter Property="RenderTransform">
                <ScaleTransform ScaleX="1.15" ScaleY="1.15" />
            </Setter>
        </Style>

        <!-- PlayStopButton 悬停动画 -->
        <Style Selector="Button.PlayStopButton">
            <Setter Property="RenderTransformOrigin" Value="50%,50%" />
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <ScaleTransform ScaleX="1" ScaleY="1" />
                </Setter.Value>
            </Setter>
            <Setter Property="Opacity" Value="1" />
        </Style>

        <Style Selector="Button.PlayStopButton:pointerover">
            <Style.Animations>
                <Animation Duration="0:0:0.15" FillMode="Forward">
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1.15" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1.15" />
                        <Setter Property="Opacity" Value="0.8" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <Style Selector="Button.PlayStopButton:not(:pointerover)">
            <Style.Animations>
                <Animation Duration="0:0:0.15" FillMode="Forward">
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1" />
                        <Setter Property="Opacity" Value="1" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <Style Selector="Border#GradientButtonBorder:pointerover Border#ShineLayer1">
            <Setter Property="Background">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                        <GradientStop Color="Transparent" Offset="0.0" />
                        <GradientStop Color="Transparent" Offset="0.25" />
                        <GradientStop Color="#40FFFFFF" Offset="0.45" />
                        <GradientStop Color="#70FFFFFF" Offset="0.5" />
                        <GradientStop Color="#40FFFFFF" Offset="0.55" />
                        <GradientStop Color="Transparent" Offset="0.75" />
                        <GradientStop Color="Transparent" Offset="1.0" />
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
        </Style>
        <Style Selector="Border#GradientButtonBorder:pointerover Border#ShineLayer2">
            <Setter Property="Background">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                        <GradientStop Color="Transparent" Offset="0.0" />
                        <GradientStop Color="Transparent" Offset="0.25" />
                        <GradientStop Color="#40FFFFFF" Offset="0.45" />
                        <GradientStop Color="#70FFFFFF" Offset="0.5" />
                        <GradientStop Color="#40FFFFFF" Offset="0.55" />
                        <GradientStop Color="Transparent" Offset="0.75" />
                        <GradientStop Color="Transparent" Offset="1.0" />
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
        </Style>
        <Style Selector="Border#GradientButtonBorder:pointerover Border#ShineLayer3">
            <Setter Property="Background">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                        <GradientStop Color="Transparent" Offset="0.0" />
                        <GradientStop Color="Transparent" Offset="0.25" />
                        <GradientStop Color="#40FFFFFF" Offset="0.45" />
                        <GradientStop Color="#70FFFFFF" Offset="0.5" />
                        <GradientStop Color="#40FFFFFF" Offset="0.55" />
                        <GradientStop Color="Transparent" Offset="0.75" />
                        <GradientStop Color="Transparent" Offset="1.0" />
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
        </Style>
        <!-- SyncButton图标旋转动画基础样式 -->
        <Style Selector="Button.SyncButton avalonia1|FluentIcon">
            <Setter Property="RenderTransformOrigin" Value="50%,50%" />
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <TransformGroup>
                        <ScaleTransform ScaleX="1" ScaleY="1" />
                        <RotateTransform Angle="0" />
                    </TransformGroup>
                </Setter.Value>
            </Setter>
        </Style>
        <Style Selector="Button.SyncButton fluent|FluentIcon">
            <Setter Property="RenderTransformOrigin" Value="50%,50%" />
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <TransformGroup>
                        <ScaleTransform ScaleX="1" ScaleY="1" />
                        <RotateTransform Angle="0" />
                    </TransformGroup>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- 悬停时逆时针转-15度并放大 -->
        <Style Selector="Button.SyncButton:pointerover avalonia1|FluentIcon">
            <Style.Animations>
                <Animation Duration="0:0:0.15" FillMode="Forward">
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1.1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1.1" />
                        <Setter Property="RotateTransform.Angle" Value="-15" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
        <Style Selector="Button.SyncButton:pointerover fluent|FluentIcon">
            <Style.Animations>
                <Animation Duration="0:0:0.15" FillMode="Forward">
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1.1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1.1" />
                        <Setter Property="RotateTransform.Angle" Value="-15" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <!-- 离开悬停时回到原始状态 -->
        <Style Selector="Button.SyncButton:not(:pointerover) avalonia1|FluentIcon">
            <Style.Animations>
                <Animation Duration="0:0:0.15" FillMode="Forward">
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1" />
                        <Setter Property="RotateTransform.Angle" Value="0" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
        <Style Selector="Button.SyncButton:not(:pointerover) fluent|FluentIcon">
            <Style.Animations>
                <Animation Duration="0:0:0.15" FillMode="Forward">
                    <KeyFrame Cue="100%">
                        <Setter Property="ScaleTransform.ScaleX" Value="1" />
                        <Setter Property="ScaleTransform.ScaleY" Value="1" />
                        <Setter Property="RotateTransform.Angle" Value="0" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

        <!-- 点击时顺时针转 720度（两圈） -->
        <Style Selector="Button.SyncButton:pressed avalonia1|FluentIcon">
            <Style.Animations>
                <Animation Duration="0:0:2" Easing="CubicEaseOut">
                    <KeyFrame Cue="0%">
                        <Setter Property="RotateTransform.Angle" Value="0" />
                    </KeyFrame>
                    <KeyFrame Cue="25%">
                        <Setter Property="RotateTransform.Angle" Value="360" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="RotateTransform.Angle" Value="0" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="RotateTransform.Angle" Value="360" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
        <Style Selector="Button.SyncButton:pressed fluent|FluentIcon">
            <Style.Animations>
                <Animation Duration="0:0:2" Easing="CubicEaseOut">
                    <KeyFrame Cue="0%">
                        <Setter Property="RotateTransform.Angle" Value="0" />
                    </KeyFrame>
                    <KeyFrame Cue="25%">
                        <Setter Property="RotateTransform.Angle" Value="360" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="RotateTransform.Angle" Value="0" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="RotateTransform.Angle" Value="360" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
    </UserControl.Styles>


    <!-- 主布局：两行结构 -->
    <Grid ClipToBounds="False" Margin="0,0,0,0" RowDefinitions="Auto,*" x:Name="MainGrid">

        <!-- 第一行：顶部工具栏（资源选择 + 连接设置） -->
        <suki:GlassCard Grid.Row="0" Margin="15,15,15,5" Padding="12,8" IsAnimated="False">
            <Grid x:Name="TopToolbar">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <!-- 在 TopToolbar Grid 中添加新列，放在资源选择之前 -->
                <Grid x:Name="ConfigSelectorPanel" Grid.Column="0" VerticalAlignment="Center" ColumnDefinitions="Auto,*">
                    <TextBlock FontSize="12" Grid.Column="0"
                               FontWeight="Bold" Foreground="{DynamicResource SukiLowText}"
                               Text="{markup:I18n {x:Static helper:LangKeys.CurrentConfig}}"
                               VerticalAlignment="Center" />
                    <ComboBox Margin="8 0 0 0" Grid.Column="1"
                              ex:ComboBoxExtensions.DisableNavigationOnLostFocus="True"
                              IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                              ItemsSource="{Binding ConfigurationList}"
                              SelectedValue="{Binding CurrentConfiguration}"
                              SelectedValueBinding="{Binding Name}"
                              MinWidth="120">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Name}" TextTrimming="CharacterEllipsis" />
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>

                </Grid>
                <!-- ~1~ 添加分隔符 @1@ -->
                <Border x:Name="Spliter1" Grid.Column="1" Width="1" Height="30" Background="{DynamicResource SukiControlBorderBrush}" Margin="20,0" />

                <!-- 左侧：资源选择 -->
                <Grid x:Name="ResourceSelectorPanel" Grid.Column="2" VerticalAlignment="Center" ColumnDefinitions="Auto,*">
                    <TextBlock FontSize="12" Grid.Column="0"
                               FontWeight="Bold" Foreground="{DynamicResource SukiLowText}"
                               Text="{markup:I18n {x:Static helper:LangKeys.ResourceOption}}"
                               VerticalAlignment="Center" />
                    <ComboBox Margin="8 0 0 0" Grid.Column="1"
                              ex:ComboBoxExtensions.DisableNavigationOnLostFocus="True"
                              IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                              ItemsSource="{Binding CurrentResources}"
                              MinWidth="150" HorizontalAlignment="Stretch"
                              SelectedValue="{Binding CurrentResource}"
                              SelectedValueBinding="{Binding Name}" VerticalAlignment="Center">
                        <ComboBox.ItemTemplate>
                            <DataTemplate x:DataType="maa:MaaInterface+MaaInterfaceResource">
                                <Grid ColumnDefinitions="Auto,*,40">
                                    <controls:DisplayIcon Grid.Column="0" IconSource="{Binding ResolvedIcon}"
                                                          IconSize="20" IsVisible="{Binding HasIcon}" Margin="0,0,6,0"
                                                          VerticalAlignment="Center" />
                                    <TextBlock Background="Transparent" Foreground="{DynamicResource SukiText}"
                                               Grid.Column="1"
                                               Text="{Binding DisplayName}"
                                               TextTrimming="CharacterEllipsis"
                                               VerticalAlignment="Center" />
                                    <controls:TooltipBlock Grid.Column="2" IsVisible="{Binding HasDescription}"
                                                           TooltipText="{Binding DisplayDescription}" />
                                </Grid>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                        <ComboBox.SelectionBoxItemTemplate>
                            <DataTemplate>
                                <Grid ColumnDefinitions="Auto,*,40">
                                    <controls:DisplayIcon Grid.Column="0" IconSource="{Binding ResolvedIcon}"
                                                          IconSize="20" IsVisible="{Binding HasIcon}" Margin="0,0,6,0"
                                                          VerticalAlignment="Center" />
                                    <TextBlock Background="Transparent" Foreground="{DynamicResource SukiText}"
                                               Grid.Column="1"
                                               Text="{Binding DisplayName}"
                                               TextTrimming="CharacterEllipsis"
                                               VerticalAlignment="Center" />
                                    <controls:TooltipBlock Grid.Column="2" IsVisible="{Binding HasDescription}"
                                                           TooltipText="{Binding DisplayDescription}" />
                                </Grid>
                            </DataTemplate>
                        </ComboBox.SelectionBoxItemTemplate>
                    </ComboBox>
                </Grid>

                <!-- 中间：分隔符 -->
                <Border Grid.Column="3" Width="1" Height="30" Background="{DynamicResource SukiControlBorderBrush}" x:Name="Spliter2"
                        Margin="20,0" />
                <!-- 控制器类型选择 -->
                <Grid x:Name="ControllerSelectorPanel" Grid.Column="4" VerticalAlignment="Center" ColumnDefinitions="Auto,*">
                    <TextBlock Grid.Column="0" FontSize="12"
                               FontWeight="Bold" Foreground="{DynamicResource SukiLowText}"
                               Text="{markup:I18n {x:Static helper:LangKeys.ControllerType}}"
                               VerticalAlignment="Center" />
                    <ComboBox Margin="8 0 0 0" Grid.Column="1" x:Name="ControllerComboBox"
                              ex:ComboBoxExtensions.DisableNavigationOnLostFocus="True"
                              IsEnabled="{calcBinding:Binding '!LockController and Idle',Source={x:Static helper:Instances.RootViewModel}}"
                              ItemsSource="{Binding ControllerOptions}"
                              SelectedItem="{Binding SelectedController, Mode=TwoWay}"
                              MinWidth="120" VerticalAlignment="Center">
                        <ComboBox.ItemTemplate>
                            <DataTemplate x:DataType="maa:MaaInterface+MaaResourceController">
                                <Grid ColumnDefinitions="Auto,*">
                                    <controls:DisplayIcon Grid.Column="0" IconSource="{Binding ResolvedIcon}"
                                                          IconSize="20" IsVisible="{Binding HasIcon}" Margin="0,0,6,0"
                                                          VerticalAlignment="Center" />
                                    <TextBlock Background="Transparent" Foreground="{DynamicResource SukiText}"
                                               Grid.Column="1"
                                               Text="{Binding DisplayName}"
                                               TextTrimming="CharacterEllipsis"
                                               VerticalAlignment="Center" />
                                </Grid>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                        <ComboBox.SelectionBoxItemTemplate>
                            <DataTemplate>
                                <Grid ColumnDefinitions="Auto,*">
                                    <controls:DisplayIcon Grid.Column="0" IconSource="{Binding ResolvedIcon}"
                                                          IconSize="20" IsVisible="{Binding HasIcon}" Margin="0,0,6,0"
                                                          VerticalAlignment="Center" />
                                    <TextBlock Background="Transparent" Foreground="{DynamicResource SukiText}"
                                               Grid.Column="1"
                                               Text="{Binding DisplayName}"
                                               TextTrimming="CharacterEllipsis"
                                               VerticalAlignment="Center" />
                                </Grid>
                            </DataTemplate>
                        </ComboBox.SelectionBoxItemTemplate>
                    </ComboBox>
                </Grid>
                <!-- 右侧：连接设置 -->
                <Grid x:Name="DeviceSelectorPanel" Grid.Column="5" HorizontalAlignment="Stretch"
                      MinWidth="200">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" x:Name="DeviceSelectorLabel"
                               FontSize="12" Margin="8 0"
                               FontWeight="Bold" Foreground="{DynamicResource SukiLowText}"
                               Text="{markup:I18n {x:Static helper:LangKeys.CurrentController}}"
                               VerticalAlignment="Center" />
                    <ComboBox Grid.Column="1" x:Name="DeviceComboBox"
                              ex:ComboBoxExtensions.DisableNavigationOnLostFocus="True"
                              Classes="LimitWidth" Height="35"
                              IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                              ItemsSource="{Binding Devices}"
                              MinWidth="100"
                              HorizontalAlignment="Stretch"
                              SelectedValue="{Binding CurrentDevice, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                        <ToolTip.Tip>
                            <TextBlock
                                Text="{Binding CurrentDevice, Converter={converters:DeviceDisplayConverter}}" />
                        </ToolTip.Tip>
                        <ComboBox.DataTemplates>
                            <DataTemplate DataType="binding:AdbDeviceInfo">
                                <TextBlock HorizontalAlignment="Left"
                                           Text="{Binding Converter={converters:DeviceDisplayConverter}}" />
                            </DataTemplate>
                            <DataTemplate DataType="binding:DesktopWindowInfo">
                                <TextBlock HorizontalAlignment="Left"
                                           Text="{Binding Name}" />
                            </DataTemplate>
                        </ComboBox.DataTemplates>
                    </ComboBox>
                    <StackPanel x:Name="ConnectionButtonsPanel" Grid.Column="2" Orientation="Horizontal"
                                VerticalAlignment="Center" Spacing="4">
                        <StackPanel.Resources>
                            <markup:IfConditionConverter x:Key="ConnectedConditionConverter">
                                <markup:IfConditionConverter.True>
                                    <Path Data="{StaticResource ConnectedGeometry}" Fill="LimeGreen"
                                          Height="11" Margin="3,2,4,0" Stretch="Uniform"
                                          ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.Connected}}" />
                                </markup:IfConditionConverter.True>
                                <markup:IfConditionConverter.False>
                                    <Path Data="{StaticResource UnconnectedGeometry}" Fill="Red"
                                          Height="16" Margin="3,3,4,0" Stretch="Uniform"
                                          ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.Unconnected}}"
                                          VerticalAlignment="Center" />
                                </markup:IfConditionConverter.False>
                            </markup:IfConditionConverter>
                        </StackPanel.Resources>
                        <Button Classes="Basic Round" ClipToBounds="False"
                                Command="{Binding CustomAdbCommand}"
                                IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                                IsVisible="{calcBinding:Binding 'CurrentController == maa:MaaControllerTypes.Adb'}"
                                Padding="0" ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.Custom}}">
                            <avalonia1:FluentIcon Height="18" Icon="DesktopEdit" IconSize="Size16"
                                                  IconVariant="Regular" />
                        </Button>
                        <Button Classes="Basic Round SyncButton" ClipToBounds="False"
                                Command="{Binding RefreshCommand}"
                                IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                                Padding="0"
                                ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.TooltipRefresh}}"
                                VerticalAlignment="Center">
                            <avalonia1:FluentIcon Height="18" Icon="ArrowSync" IconSize="Size16" IconVariant="Regular" />
                        </Button>
                        <ContentControl
                            Content="{Binding IsConnected, Converter={StaticResource ConnectedConditionConverter}, Source={x:Static helper:Instances.TaskQueueViewModel}}" />
                    </StackPanel>
                </Grid>

            </Grid>
        </suki:GlassCard>
        <ScrollViewer x:Name="ThreeColumnScrollViewer" Grid.Row="1" VerticalScrollBarVisibility="Disabled"
                      HorizontalScrollBarVisibility="Disabled">
            <Grid ClipToBounds="False" Margin="0,0,0,0" x:Name="ThreeColumnGrid">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition
                        Width="{Binding Column1Width, Source={x:Static helper:Instances.TaskQueueViewModel}, Mode=TwoWay}"
                        MinWidth="40" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition
                        Width="{Binding Column2Width, Source={x:Static helper:Instances.TaskQueueViewModel}, Mode=TwoWay}"
                        MinWidth="200" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition
                        Width="{Binding Column3Width, Source={x:Static helper:Instances.TaskQueueViewModel}, Mode=TwoWay}"
                        MinWidth="40" />
                </Grid.ColumnDefinitions>


                <!-- 左侧列：任务设置 -->
                <suki:GlassCard IsAnimated="False" Grid.Column="0" Margin="15,5,0,25" x:Name="SettingCard"
                                PointerPressed="SettingCard_PointerPressed"
                                ClipToBounds="True">
                    <suki:GlassCard.Resources>
                        <suki:IfConditionConverter x:Key="IfConditionConverter">
                            <suki:IfConditionConverter.True>
                                <Thickness>0,1,0,10</Thickness>
                            </suki:IfConditionConverter.True>
                            <suki:IfConditionConverter.False>
                                <Thickness>0,10,0,10</Thickness>
                            </suki:IfConditionConverter.False>
                        </suki:IfConditionConverter>
                    </suki:GlassCard.Resources>
                    <Grid>
                        <!-- 展开时显示的内容 -->
                        <suki:GroupBox x:Name="LeftPanelContent"
                                       SeparatorMargin="{Binding ShowSettings,Converter={StaticResource IfConditionConverter}}"
                                       IsVisible="{Binding !IsLeftPanelCollapsed, Source={x:Static helper:Instances.TaskQueueViewModel}}"
                                       RenderTransformOrigin="0,0.5">
                            <suki:GroupBox.RenderTransform>
                                <TranslateTransform X="0" />
                            </suki:GroupBox.RenderTransform>
                            <suki:GroupBox.Header>
                                <DockPanel>
                                    <Button Classes="Basic PanelToggleButton" DockPanel.Dock="Left"
                                            Command="{Binding ToggleLeftPanelCommand, Source={x:Static helper:Instances.TaskQueueViewModel}}"
                                            Padding="2" Margin="0,-5,8,0"
                                            Width="20" Height="20" CornerRadius="4">
                                        <avalonia1:FluentIcon Icon="ChevronLeft" IconSize="Size16" />
                                    </Button>
                                    <TextBlock DockPanel.Dock="Left"
                                               FontSize="11"
                                               FontWeight="Bold" Foreground="{DynamicResource SukiLowText}"
                                               HorizontalAlignment="Left"
                                               Margin="2,0,0,0"
                                               Text="{markup:I18n {x:Static helper:LangKeys.TaskSettings}}"
                                               VerticalAlignment="Top" />
                                    <StackPanel Margin="2 0 0 5" Orientation="Horizontal"
                                                HorizontalAlignment="Right"
                                                DockPanel.Dock="Right"
                                                IsVisible="{Binding ShowSettings}" Spacing="8">
                                        <RadioButton FontSize="11" FontWeight="Bold"
                                                     Classes="Inner" IsChecked="{Binding IsCommon}"
                                                     GroupName="SettingA">
                                            <TextBlock Text="{markup:I18n {x:Static helper:LangKeys.CommonSetting}}" />
                                        </RadioButton>
                                        <RadioButton FontSize="11" FontWeight="Bold" Classes="Inner"
                                                     GroupName="SettingA"
                                                     IsChecked="{calcBinding:Binding '!IsCommon'}">
                                            <TextBlock Text="{markup:I18n {x:Static helper:LangKeys.AdvancedSetting}}" />
                                        </RadioButton>
                                    </StackPanel>
                                </DockPanel>
                            </suki:GroupBox.Header>
                            <ScrollViewer HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                                          VerticalScrollBarVisibility="Auto">
                                <Grid>
                                    <StackPanel IsVisible="{calcBinding:Binding 'IsCommon'}"
                                                x:Name="CommonOptionSettings" Orientation="Vertical" />
                                    <StackPanel IsVisible="{calcBinding:Binding '!IsCommon'}"
                                                x:Name="AdvancedOptionSettings" Orientation="Vertical" />
                                </Grid>
                            </ScrollViewer>
                        </suki:GroupBox>
                        <!-- 折叠时显示的展开按钮 -->
                        <Button Classes="Basic ExpandButton" x:Name="LeftExpandButton"
                                Command="{Binding ToggleLeftPanelCommand, Source={x:Static helper:Instances.TaskQueueViewModel}}"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                Padding="4"
                                Width="30" Height="60"
                                CornerRadius="4" Opacity="0"
                                IsVisible="{Binding IsLeftPanelCollapsed, Source={x:Static helper:Instances.TaskQueueViewModel}}"
                                ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.TaskSettings}}">
                            <avalonia1:FluentIcon Icon="ChevronRight" IconSize="Size20" />
                        </Button>
                    </Grid>
                </suki:GlassCard>

                <!-- 第一个GridSplitter -->
                <GridSplitter Grid.Column="1" Background="Transparent"
                              Width="15"
                              HorizontalAlignment="Center"
                              VerticalAlignment="Stretch"
                              DragCompleted="GridSplitter_DragCompleted"
                              IsEnabled="{Binding !IsLeftPanelCollapsed, Source={x:Static helper:Instances.TaskQueueViewModel}}"
                              x:Name="Splitter1">
                    <GridSplitter.Template>
                        <ControlTemplate>
                            <Border Background="Transparent" VerticalAlignment="Stretch"
                                    HorizontalAlignment="Stretch" Cursor="SizeWestEast">
                                <StackPanel VerticalAlignment="Center"
                                            HorizontalAlignment="Center" Spacing="3"
                                            IsVisible="{Binding !IsLeftPanelCollapsed, Source={x:Static helper:Instances.TaskQueueViewModel}}">
                                    <Ellipse Width="4" Height="4"
                                             Fill="{DynamicResource SukiControlBorderBrush}" />
                                    <Ellipse Width="4"
                                             Height="4"
                                             Fill="{DynamicResource SukiControlBorderBrush}" />
                                    <Ellipse Width="4"
                                             Height="4"
                                             Fill="{DynamicResource SukiControlBorderBrush}" />
                                </StackPanel>
                            </Border>
                        </ControlTemplate>
                    </GridSplitter.Template>
                    <interaction:Interaction.Behaviors>
                        <behaviors:EventTriggerBehavior EventName="DragStarted">
                            <behaviors:InvokeCommandAction Command="{Binding GridSplitterDragStartedCommand}"
                                                           CommandParameter="Splitter1" />
                        </behaviors:EventTriggerBehavior>
                        <behaviors:EventTriggerBehavior EventName="DragCompleted">
                            <behaviors:InvokeCommandAction Command="{Binding GridSplitterDragCompletedCommand}"
                                                           CommandParameter="Splitter1" />
                        </behaviors:EventTriggerBehavior>
                    </interaction:Interaction.Behaviors>
                </GridSplitter>

                <!-- 中间列：执行队列 + 开始按钮 + IntroductionCard -->
                <Grid Grid.Column="2" x:Name="Grid1" RowDefinitions="*,Auto">


                    <!-- 执行队列（原任务列表） -->
                    <suki:GlassCard IsAnimated="False" Grid.Row="0" Margin="0,5,0,25" x:Name="TaskListCard">
                        <suki:GroupBox>
                            <suki:GroupBox.Header>
                                <Grid>
                                    <TextBlock FontSize="11"
                                               FontWeight="Bold" Foreground="{DynamicResource SukiLowText}"
                                               HorizontalAlignment="Left"
                                               Margin="2,0,0,0"
                                               Text="{markup:I18n {x:Static helper:LangKeys.TaskList}}"
                                               VerticalAlignment="Center" />
                                    <StackPanel HorizontalAlignment="Right"
                                                Margin="2,0,2,0"
                                                Orientation="Horizontal" VerticalAlignment="Center">
                                        <Button Classes="Basic Round" ClipToBounds="False"
                                                Command="{Binding SelectAllCommand}"
                                                Height="16"
                                                IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                                                Margin="7,0,0,0" Padding="0"
                                                ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.SelectAll}}"
                                                Width="16">
                                            <fluent:FluentIcon Icon="SelectAllOn" IconSize="Size16"
                                                               IconVariant="Regular" />
                                        </Button>
                                        <Button Classes="Basic Round" ClipToBounds="False"
                                                Command="{Binding SelectNoneCommand}"
                                                Height="16"
                                                IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                                                Margin="7,0,0,0" Padding="0"
                                                ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.DeselectAll}}"
                                                Width="16">
                                            <fluent:FluentIcon Icon="SelectAllOff" IconSize="Size16"
                                                               IconVariant="Regular" />
                                        </Button>
                                        <Button Classes="Basic Round" ClipToBounds="False"
                                                Command="{Binding AddTaskCommand}"
                                                Height="16"
                                                IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                                                Margin="7,0,0,0" Padding="0"
                                                ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.AddTask}}">
                                            <fluent:FluentIcon Icon="AddSquareMultiple" IconSize="Size16"
                                                               IconVariant="Regular" />
                                        </Button>
                                        <Button
                                            Command="{Binding ResetTasksCommand}" Classes="Basic Round SyncButton"
                                            IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                                            Margin="7,0,2,0"
                                            Padding="0"
                                            ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.Reset}}">
                                            <avalonia1:FluentIcon Height="18" Icon="ArrowSync" IconSize="Size16"
                                                                  IconVariant="Regular" />
                                        </Button>
                                        <!--竖屏模式下的简单开始/停止按钮-->
                                        <!--开始任务按钮（竖屏模式 + 非运行状态） -->
                                        <Button Classes="Basic Round PlayStopButton"
                                                IsEnabled="{Binding ToggleEnable}"
                                                Command="{Binding ToggleCommand}"
                                                FontWeight="DemiBold"
                                                Height="28" Width="28"
                                                Padding="0" Margin="0,0,7,0"
                                                Cursor="Hand"
                                                Background="Transparent"
                                                BorderThickness="0"
                                                ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.StartTask}}">
                                            <Button.IsVisible>
                                                <MultiBinding
                                                    Converter="{x:Static converters:BooleanAndConverter.NegateSecond}">
                                                    <Binding Path="IsCompactMode"
                                                             Source="{x:Static helper:Instances.TaskQueueViewModel}" />
                                                    <Binding Path="IsRunning"
                                                             Source="{x:Static helper:Instances.RootViewModel}" />
                                                </MultiBinding>
                                            </Button.IsVisible>
                                            <Path Data="{StaticResource PlayGeometry}"
                                                  Fill="{DynamicResource SukiPrimaryColor}"
                                                  Width="12" Height="12"
                                                  Stretch="Uniform"
                                                  VerticalAlignment="Center"
                                                  HorizontalAlignment="Center" />
                                        </Button>

                                        <!-- 停止任务按钮（竖屏模式 + 运行状态） -->
                                        <Button Classes="Basic Round PlayStopButton"
                                                IsEnabled="{Binding ToggleEnable}"
                                                Command="{Binding ToggleCommand}"
                                                FontWeight="DemiBold"
                                                Height="28" Width="28"
                                                Padding="0"
                                                Margin="0,0,7,0"
                                                Cursor="Hand"
                                                Background="Transparent"
                                                BorderThickness="0"
                                                ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.StopTask}}">
                                            <Button.IsVisible>
                                                <MultiBinding
                                                    Converter="{x:Static converters:BooleanAndConverter.Instance}">
                                                    <Binding Path="IsCompactMode"
                                                             Source="{x:Static helper:Instances.TaskQueueViewModel}" />
                                                    <Binding Path="IsRunning"
                                                             Source="{x:Static helper:Instances.RootViewModel}" />
                                                </MultiBinding>
                                            </Button.IsVisible>
                                            <Path Data="{StaticResource StopGeometry}"
                                                  Fill="{DynamicResource SukiPrimaryColor}"
                                                  Width="12" Height="12"
                                                  Stretch="Uniform"
                                                  VerticalAlignment="Center"
                                                  HorizontalAlignment="Center" />
                                        </Button>


                                    </StackPanel>
                                </Grid>
                            </suki:GroupBox.Header>
                            <Grid>
                                <ListBox Classes="Fluent"
                                         DragDrop.AllowDrop="{Binding Idle,Source={x:Static helper:Instances.RootViewModel}}"
                                         ex:DragDropExtensions.EnableDragDrop="True"
                                         ex:DragDropExtensions.DragStartThreshold="2"
                                         ex:DragDropExtensions.EnableAnimation="True"
                                         ItemsSource="{Binding Path=TaskItemViewModels}" Margin="0,3,0,0"
                                         MinHeight="150"
                                         HorizontalAlignment="Stretch"
                                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                                         SelectionChanged="SelectingItemsControl_OnSelectionChanged"
                                         x:Name="TaskListBox">
                                    <ListBox.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel />
                                        </ItemsPanelTemplate>
                                    </ListBox.ItemsPanel>
                                    <ListBox.Styles>
                                        <Style Selector="ListBoxItem" x:DataType="valueType:DragItemViewModel">
                                            <Setter Property="IsVisible" Value="{Binding IsResourceSupported}" />
                                        </Style>
                                    </ListBox.Styles>
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Grid
                                                ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.TooltipDragLabel}}"
                                                Background="Transparent"
                                                ex:DragDropExtensions.LimitDragDrop="True" ColumnDefinitions="*,Auto"
                                                ContextMenu="{StaticResource TaskMenu}"
                                                x:Name="ListGrid">
                                                <CheckBox IsThreeState="True" Content="{Binding }" Grid.Column="0"
                                                          MinWidth="150"
                                                          ex:CheckBoxExtensions.EnableRightClickNull="{Binding !IsResourceOptionItem}"
                                                          HorizontalAlignment="Left"
                                                          ex:CheckBoxExtensions.LimitDragDrop="True"
                                                          IsEnabled="{Binding !IsResourceOptionItem}"
                                                          IsChecked="{Binding IsCheckedWithNull}">
                                                    <CheckBox.ContentTemplate>
                                                        <DataTemplate x:DataType="valueType:DragItemViewModel">
                                                            <Grid ColumnDefinitions="Auto,*">
                                                                <controls:DisplayIcon Grid.Column="0"
                                                                        IconSource="{Binding ResolvedIcon}"
                                                                        IconSize="20"
                                                                        IsVisible="{Binding HasIcon}" Margin="0,0,6,0"
                                                                        VerticalAlignment="Center" />
                                                                <TextBlock Grid.Column="1" Text="{Binding Name}"
                                                                           TextTrimming="CharacterEllipsis"
                                                                           TextWrapping="NoWrap" />
                                                            </Grid>
                                                        </DataTemplate>
                                                    </CheckBox.ContentTemplate>
                                                </CheckBox>
                                                <!-- ReSharper disable once Xaml.StaticResourceNotResolved -->
                                                <RadioButton Classes="Icon" Background="Transparent"
                                                             IsHitTestVisible="False"
                                                             BorderThickness="0"
                                                             IsChecked="{Binding EnableSetting}"
                                                             Grid.Column="1" ex:IconElement.Width="16"
                                                             ex:IconElement.Height="16"
                                                             ex:IconElement.Geometry="{x:Static suki:Icons.Setting}"
                                                             GroupName="TaskSettings" IsVisible="{Binding IsVisible}"
                                                             HorizontalContentAlignment="Right" />
                                            </Grid>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </Grid>
                        </suki:GroupBox>
                    </suki:GlassCard>


                    <!-- IntroductionCard（任务描述） -->
                    <suki:GlassCard IsAnimated="False" Grid.Row="1" Margin="0,-15,0,25" x:Name="IntroductionCard">
                        <suki:GroupBox>
                            <suki:GroupBox.Header>
                                <TextBlock FontSize="11"
                                           FontWeight="Bold" Foreground="{DynamicResource SukiLowText}"
                                           HorizontalAlignment="Left"
                                           Margin="2,0,0,0"
                                           Text="{markup:I18n {x:Static helper:LangKeys.TaskDescription}}"
                                           VerticalAlignment="Center" />
                            </suki:GroupBox.Header>
                            <ScrollViewer HorizontalScrollBarVisibility="Disabled"
                                          VerticalScrollBarVisibility="Auto">
                                <mdxaml:MarkdownScrollViewer Focusable="True" x:Name="Introduction" Margin="10,0,10,0">
                                    <mdxaml:MarkdownScrollViewer.Engine>
                                        <ex:MarkdownExtension />
                                    </mdxaml:MarkdownScrollViewer.Engine>
                                    <mdxaml:MarkdownScrollViewer.Styles>
                                        <StyleInclude Source="avares://MFAAvalonia/Assets/Style/MdXamlDocStyle.axaml" />
                                    </mdxaml:MarkdownScrollViewer.Styles>
                                    <mdxaml:MarkdownScrollViewer.Plugins>
                                        <StaticResource ResourceKey="MdXamlPlugin" />
                                    </mdxaml:MarkdownScrollViewer.Plugins>
                                </mdxaml:MarkdownScrollViewer>
                            </ScrollViewer>
                        </suki:GroupBox>
                    </suki:GlassCard><!--开始运行按钮 -->
                    <StackPanel Grid.Row="0" HorizontalAlignment="Center" VerticalAlignment="Bottom" Grid.RowSpan="2"
                                Margin="0,5,0,5" x:Name="StartButtonPanel" IsVisible="{Binding '!IsCompactMode'}"
                                Orientation="Horizontal">

                        <Border CornerRadius="100" Height="40"
                                Width="180" Cursor="Hand"
                                ClipToBounds="True"
                                x:Name="GradientButtonBorder">
                            <Border.Styles>
                                <Style Selector="Border#GradientButtonBorder">
                                    <Setter Property="Background">
                                        <Setter.Value>
                                            <LinearGradientBrush StartPoint="0%,50%" EndPoint="100%,50%">
                                                <GradientStop Color="{DynamicResource SukiPrimaryColor}" Offset="0.0" />
                                                <GradientStop Color="{DynamicResource SukiPrimaryColor}" Offset="1.0" />
                                            </LinearGradientBrush>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                                <Style Selector="Border#GradientButtonBorder:pointerover">
                                    <Setter Property="Background">
                                        <Setter.Value>
                                            <LinearGradientBrush StartPoint="0%,50%" EndPoint="100%,50%">
                                                <GradientStop Color="{DynamicResource SukiPrimaryColor75}" Offset="0.0" />
                                                <GradientStop Color="{DynamicResource SukiPrimaryColor75}" Offset="1.0" />
                                            </LinearGradientBrush>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                                <!--第一层高光动画 -->
                                <Style Selector="Border#ShineLayer1">
                                    <Setter Property="RenderTransform">
                                        <Setter.Value>
                                            <TranslateTransform X="-200" />
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Animations>
                                        <Animation Duration="0:0:1.8" IterationCount="INFINITE">
                                            <KeyFrame Cue="0%">
                                                <Setter Property="TranslateTransform.X" Value="-200" />
                                            </KeyFrame>
                                            <KeyFrame Cue="100%">
                                                <Setter Property="TranslateTransform.X" Value="200" />
                                            </KeyFrame>
                                        </Animation>
                                    </Style.Animations>
                                </Style>
                                <!-- 第二层高光动画 - 延迟1/3 -->
                                <Style Selector="Border#ShineLayer2">
                                    <Setter Property="RenderTransform">
                                        <Setter.Value>
                                            <TranslateTransform X="-200" />
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Animations>
                                        <Animation Duration="0:0:1.8" IterationCount="INFINITE" Delay="0:0:0.6">
                                            <KeyFrame Cue="0%">
                                                <Setter Property="TranslateTransform.X" Value="-200" />
                                            </KeyFrame>
                                            <KeyFrame Cue="100%">
                                                <Setter Property="TranslateTransform.X" Value="200" />
                                            </KeyFrame>
                                        </Animation>
                                    </Style.Animations>
                                </Style>
                                <!-- 第三层高光动画 - 延迟2/3 -->
                                <Style Selector="Border#ShineLayer3">
                                    <Setter Property="RenderTransform">
                                        <Setter.Value>
                                            <TranslateTransform X="-200" />
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Animations>
                                        <Animation Duration="0:0:1.8" IterationCount="INFINITE" Delay="0:0:1.2">
                                            <KeyFrame Cue="0%">
                                                <Setter Property="TranslateTransform.X" Value="-200" />
                                            </KeyFrame>
                                            <KeyFrame Cue="100%">
                                                <Setter Property="TranslateTransform.X" Value="200" />
                                            </KeyFrame>
                                        </Animation>
                                    </Style.Animations>
                                </Style>
                            </Border.Styles>
                            <Grid>
                                <!-- 第一层流动高光 -->
                                <Border x:Name="ShineLayer1"
                                        Width="350"
                                        CornerRadius="100"
                                        IsHitTestVisible="False"
                                        HorizontalAlignment="Left">
                                    <Border.Background>
                                        <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                                            <GradientStop Color="Transparent" Offset="0.0" />
                                            <GradientStop Color="Transparent" Offset="0.25" />
                                            <GradientStop Color="#25FFFFFF" Offset="0.45" />
                                            <GradientStop Color="#50FFFFFF" Offset="0.5" />
                                            <GradientStop Color="#25FFFFFF" Offset="0.55" />
                                            <GradientStop Color="Transparent" Offset="0.75" />
                                            <GradientStop Color="Transparent" Offset="1.0" />
                                        </LinearGradientBrush>
                                    </Border.Background>
                                </Border>
                                <!-- 第二层流动高光 -->
                                <Border x:Name="ShineLayer2"
                                        Width="350"
                                        CornerRadius="100"
                                        IsHitTestVisible="False"
                                        HorizontalAlignment="Left">
                                    <Border.Background>
                                        <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                                            <GradientStop Color="Transparent" Offset="0.0" />
                                            <GradientStop Color="Transparent" Offset="0.25" />
                                            <GradientStop Color="#25FFFFFF" Offset="0.45" />
                                            <GradientStop Color="#50FFFFFF" Offset="0.5" />
                                            <GradientStop Color="#25FFFFFF" Offset="0.55" />
                                            <GradientStop Color="Transparent" Offset="0.75" />
                                            <GradientStop Color="Transparent" Offset="1.0" />
                                        </LinearGradientBrush>
                                    </Border.Background>
                                </Border>
                                <!-- 第三层流动高光 -->
                                <Border x:Name="ShineLayer3"
                                        Width="350"
                                        CornerRadius="100"
                                        IsHitTestVisible="False"
                                        HorizontalAlignment="Left">
                                    <Border.Background>
                                        <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                                            <GradientStop Color="Transparent" Offset="0.0" />
                                            <GradientStop Color="Transparent" Offset="0.25" />
                                            <GradientStop Color="#25FFFFFF" Offset="0.45" />
                                            <GradientStop Color="#50FFFFFF" Offset="0.5" />
                                            <GradientStop Color="#25FFFFFF" Offset="0.55" />
                                            <GradientStop Color="Transparent" Offset="0.75" />
                                            <GradientStop Color="Transparent" Offset="1.0" />
                                        </LinearGradientBrush>
                                    </Border.Background>
                                </Border>
                                <!-- 按钮 -->
                                <Button Classes="Flat Rounded" IsEnabled="{Binding ToggleEnable}"
                                        Command="{Binding ToggleCommand}"
                                        Content="{Binding IsRunning, Source={x:Static helper:Instances.RootViewModel}, Converter={StaticResource StatusConditionConverter}}"
                                        FontWeight="DemiBold"
                                        Height="40"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        HorizontalAlignment="Stretch"
                                        VerticalAlignment="Stretch" />
                            </Grid>
                        </Border>
                    </StackPanel>
                </Grid>
                <!-- 第二个GridSplitter -->
                <GridSplitter Grid.Column="3" Background="Transparent"
                              Width="15"
                              HorizontalAlignment="Center"
                              VerticalAlignment="Stretch"
                              DragCompleted="GridSplitter_DragCompleted"
                              IsEnabled="{Binding !IsRightPanelCollapsed, Source={x:Static helper:Instances.TaskQueueViewModel}}"
                              x:Name="Splitter2">
                    <GridSplitter.Template>
                        <ControlTemplate>
                            <Border Background="Transparent" VerticalAlignment="Stretch"
                                    HorizontalAlignment="Stretch" Cursor="SizeWestEast">
                                <StackPanel VerticalAlignment="Center"
                                            HorizontalAlignment="Center" Spacing="3"
                                            IsVisible="{Binding !IsRightPanelCollapsed, Source={x:Static helper:Instances.TaskQueueViewModel}}">
                                    <Ellipse Width="4" Height="4" Fill="{DynamicResource SukiControlBorderBrush}" />
                                    <Ellipse Width="4" Height="4"
                                             Fill="{DynamicResource SukiControlBorderBrush}" />
                                    <Ellipse Width="4" Height="4"
                                             Fill="{DynamicResource SukiControlBorderBrush}" />
                                </StackPanel>
                            </Border>
                        </ControlTemplate>
                    </GridSplitter.Template>
                    <interaction:Interaction.Behaviors>
                        <behaviors:EventTriggerBehavior EventName="DragStarted">
                            <behaviors:InvokeCommandAction Command="{Binding GridSplitterDragStartedCommand}"
                                                           CommandParameter="Splitter2" />
                        </behaviors:EventTriggerBehavior>
                        <behaviors:EventTriggerBehavior EventName="DragCompleted">
                            <behaviors:InvokeCommandAction Command="{Binding GridSplitterDragCompletedCommand}"
                                                           CommandParameter="Splitter2" />
                        </behaviors:EventTriggerBehavior>
                    </interaction:Interaction.Behaviors>
                </GridSplitter>

                <Grid Grid.Column="4" RowDefinitions="Auto,*" Margin=" 0 0 5 0">

                    <!-- Live View Card -->
                    <suki:GlassCard Grid.Row="0" IsAnimated="False" Margin="0,0,0,10"
                                    x:Name="LiveViewCard"
                                    IsVisible="{Binding IsLiveViewVisible, Source={x:Static helper:Instances.TaskQueueViewModel}}">
                        <suki:GroupBox>
                            <suki:GroupBox.Header>
                                <Grid>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Spacing="8">
                                        <TextBlock FontSize="11" FontWeight="Bold"
                                                   Foreground="{DynamicResource SukiLowText}"
                                                   Text="{markup:I18n {x:Static helper:LangKeys.LiveView}}" />
                                    </StackPanel>
                                    <!-- 折叠按钮 -->
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
                                        <!-- 折叠按钮 - 使用 ChevronDown + 旋转动画 -->
                                        <Button Classes="Basic PanelToggleButton"
                                                HorizontalAlignment="Right"
                                                Command="{Binding ToggleLiveViewExpandedCommand, Source={x:Static helper:Instances.TaskQueueViewModel}}"
                                                Padding="2" Width="20" Height="20" CornerRadius="4">
                                            <avalonia1:FluentIcon Icon="ChevronDown" IconSize="Size16"
                                                                  x:Name="LiveViewToggleIcon"
                                                                  RenderTransformOrigin="50%,50%">
                                                <avalonia1:FluentIcon.RenderTransform>
                                                    <RotateTransform>
                                                        <RotateTransform.Angle>
                                                            <Binding Path="IsLiveViewExpanded"
                                                                     Source="{x:Static helper:Instances.TaskQueueViewModel}"
                                                                     Converter="{x:Static converters:BoolToDoubleConverter.Rotate180}" />
                                                        </RotateTransform.Angle>
                                                    </RotateTransform>
                                                </avalonia1:FluentIcon.RenderTransform>
                                            </avalonia1:FluentIcon>
                                        </Button>


                                    </StackPanel>
                                </Grid>
                            </suki:GroupBox.Header>
                            <!-- 覆盖层：状态指示器和任务名 -->
                            <!-- 图像内容区域 - 使用 Grid 实现覆盖层 -->
                            <Grid
                                IsVisible="{Binding IsLiveViewExpanded, Source={x:Static helper:Instances.TaskQueueViewModel}}"
                                Margin="0,8,0,0" HorizontalAlignment="Center">
                                <!-- 底层：圆角图像 - 添加 HorizontalAlignment 和 VerticalAlignment -->
                                <Border CornerRadius="12" ClipToBounds="True"
                                        Background="Transparent"
                                        BorderBrush="{DynamicResource SukiControlBorderBrush}"
                                        BorderThickness="0"
                                        MaxHeight="250"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Top">
                                    <Border CornerRadius="12" ClipToBounds="True">
                                        <Image
                                            Source="{Binding LiveViewImage, Source={x:Static helper:Instances.TaskQueueViewModel}}"
                                            Stretch="Uniform"
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center" />
                                    </Border>
                                </Border>


                                <!-- 覆盖层：状态指示器和任务名 -->
                                <Grid Margin="8" VerticalAlignment="Top" IsHitTestVisible="False">
                                    <!-- 左上角：运行状态指示器 -->
                                    <!-- 左上角：运行状态指示器 -->
                                    <Grid HorizontalAlignment="Left" VerticalAlignment="Top"
                                          IsVisible="{Binding IsRunning, Source={x:Static helper:Instances.RootViewModel}}">
                                        <!-- 背景层 - 半透明 -->
                                        <Border Background="{DynamicResource SukiCardBackground}"
                                                BorderBrush="{DynamicResource SukiControlBorderBrush}"
                                                BorderThickness="1" CornerRadius="12"
                                                Opacity="0.66" />
                                        <!-- 内容层 - 完全不透明 -->
                                        <StackPanel Orientation="Horizontal" Spacing="6" Margin="8,4">
                                            <Grid Width="16" Height="16" VerticalAlignment="Center">
   <!-- 外圈扩散光晕 1 -->
                                                <Ellipse x:Name="PulseRing1"
                                                         Width="8" Height="8"
                                                         Fill="Transparent"
                                                         Stroke="{DynamicResource SukiSuccessColor}"
                                                         StrokeThickness="2"
                                                         Opacity="0"
                                                         HorizontalAlignment="Center"
                                                         VerticalAlignment="Center"
                                                         RenderTransformOrigin="50%,50%">
                                                    <Ellipse.RenderTransform>
                                                        <ScaleTransform ScaleX="1" ScaleY="1" />
                                                    </Ellipse.RenderTransform>
                                                </Ellipse>

                                                <!-- 外圈扩散光晕 2 (延迟) -->
                                                <Ellipse x:Name="PulseRing2"
                                                         Width="8" Height="8"
                                                         Fill="Transparent"
                                                         Stroke="{DynamicResource SukiSuccessColor}"
                                                         StrokeThickness="2"
                                                         Opacity="0"
                                                         HorizontalAlignment="Center"
                                                         VerticalAlignment="Center"
                                                         RenderTransformOrigin="50%,50%">
                                                    <Ellipse.RenderTransform>
                                                        <ScaleTransform ScaleX="1" ScaleY="1" />
                                                    </Ellipse.RenderTransform>
                                                </Ellipse>

                                                <!-- 中心绿点 -->
                                                <Ellipse x:Name="LiveStatusDot"
                                                         Width="8" Height="8"
                                                         Fill="{DynamicResource SukiSuccessColor}"
                                                         HorizontalAlignment="Center"
                                                         VerticalAlignment="Center"
                                                         RenderTransformOrigin="50%,50%">
                                                    <Ellipse.RenderTransform>
                                                        <ScaleTransform ScaleX="1" ScaleY="1" />
                                                    </Ellipse.RenderTransform>
                                                </Ellipse>
                                            </Grid>
                                            <TextBlock Text="{markup:I18n {x:Static helper:LangKeys.Running}}"
                                                       FontSize="11"
                                                       Foreground="{DynamicResource SukiSuccessColor}"
                                                       VerticalAlignment="Center" />
                                        </StackPanel>
                                    </Grid>

                                    <!-- 右上角：当前任务名 -->
                                    <Grid HorizontalAlignment="Right" VerticalAlignment="Top"
                                          IsVisible="{Binding CurrentTaskName, Source={x:Static helper:Instances.TaskQueueViewModel}, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                        <!-- 背景层 - 半透明 -->
                                        <Border Background="{DynamicResource SukiCardBackground}"
                                                BorderBrush="{DynamicResource SukiControlBorderBrush}"
                                                BorderThickness="1" CornerRadius="12"
                                                Opacity="0.66" />
                                        <!-- 内容层 - 完全不透明 -->
                                        <StackPanel Orientation="Horizontal" Margin="8,4">
                                            <TextBlock Text="{markup:I18n {x:Static helper:LangKeys.Task}}"
                                                       FontSize="11" Foreground="{DynamicResource SukiText}" />
                                            <TextBlock Text=": " FontSize="11" Foreground="{DynamicResource SukiText}" />
                                            <TextBlock
                                                Text="{Binding CurrentTaskName, Source={x:Static helper:Instances.TaskQueueViewModel}}"
                                                FontSize="11" Foreground="{DynamicResource SukiText}" />
                                        </StackPanel>
                                    </Grid>

                                </Grid>
                            </Grid>
                        </suki:GroupBox>
                    </suki:GlassCard>
                    <!-- 右侧列：日志记录 -->
                    <suki:GlassCard Grid.Row="1"
                                    IsAnimated="False"
                                  
                                    x:Name="LogCard"
                                    PointerPressed="LogCard_PointerPressed"
                                    ClipToBounds="True">
                        <Grid>
                            <!-- 展开时显示的内容 -->
                            <suki:GroupBox x:Name="RightPanelContent"
                                           IsVisible="{Binding !IsRightPanelCollapsed, Source={x:Static helper:Instances.TaskQueueViewModel}}"
                                           RenderTransformOrigin="1,0.5">
                                <suki:GroupBox.RenderTransform>
                                    <TranslateTransform X="0" />
                                </suki:GroupBox.RenderTransform>
                                <suki:GroupBox.Header>
                                    <Grid>
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                                            <TextBlock FontSize="11"
                                                       FontWeight="Bold" Foreground="{DynamicResource SukiLowText}"
                                                       Margin="2,0,0,0"
                                                       Text="{markup:I18n {x:Static helper:LangKeys.LogRecord}}"
                                                       VerticalAlignment="Center" />
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal"
                                                    ClipToBounds="False"
                                                    HorizontalAlignment="Right">
                                            <Button Classes="Basic Round"
                                                    Command="{Binding ExportCommand}"
                                                    IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                                                    Padding="0" Margin="3,-3,3,0"
                                                    ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.ExportLog}}"
                                                    VerticalAlignment="Center">
                                                <avalonia1:FluentIcon Height="20" Icon="FolderArrowRight"
                                                                      IconSize="Size16"
                                                                      VerticalAlignment="Center" IconVariant="Regular" />
                                            </Button>

                                            <Button Classes="Basic Round SyncButton"
                                                    Command="{Binding ClearCommand}"
                                                    IsEnabled="{Binding Idle, Source={x:Static helper:Instances.RootViewModel}}"
                                                    Margin="3,0,3,0"
                                                    Padding="0"
                                                    ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.ButtonClear}}"
                                                    VerticalAlignment="Center">
                                                <fluent:FluentIcon
                                                    Icon="ArrowSync"
                                                    IconSize="Size16"
                                                    IconVariant="Regular" />
                                            </Button>
                                            <Button Classes="Basic PanelToggleButton"
                                                    Command="{Binding ToggleRightPanelCommand, Source={x:Static helper:Instances.TaskQueueViewModel}}"
                                                    Padding="0 2 8 2"
                                                    Width="20" Height="20"
                                                    CornerRadius="4">
                                                <avalonia1:FluentIcon Icon="ChevronRight" IconSize="Size16" />
                                            </Button>
                                        </StackPanel>
                                    </Grid>
                                </suki:GroupBox.Header>
                                <ScrollViewer BorderBrush="LightGray"
                                              BorderThickness="1"
                                              ClipToBounds="False"
                                              Margin="15,8,10,5" VerticalAlignment="Top" VerticalContentAlignment="Top"
                                              ex:ScrollViewerExtensions.AutoScroll="True"
                                              ex:ScrollViewerExtensions.PanningMode="VerticalOnly">
                                    <ItemsControl ItemsSource="{Binding Path=LogItemViewModels}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <StackPanel Spacing="8" />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Grid Name="ParentGrid" >
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>
                                                    <Grid.Resources>
                                                        <suki:IfConditionConverter x:Key="IfConditionConverter">
                                                            <suki:IfConditionConverter.False>
                                                                <DataTemplate DataType="other:LogItemViewModel">
                                                                    <TextBlock FontSize="12"
                                                                               FontWeight="{Binding Weight}"
                                                                               Foreground="{Binding Color}"
                                                                               Background="{Binding BackgroundColor}"
                                                                               HorizontalAlignment="Stretch"
                                                                               IsVisible="{Binding !UseMarkdown}"
                                                                               Margin="0,4.8,0,0"
                                                                               TextWrapping="WrapWithOverflow"
                                                                               Text="{Binding Content}"
                                                                               VerticalAlignment="Stretch">
                                                                    </TextBlock>
                                                                </DataTemplate>
                                                            </suki:IfConditionConverter.False>
                                                            <suki:IfConditionConverter.True>
                                                                <DataTemplate DataType="other:LogItemViewModel">
                                                                    <mdxaml:MarkdownScrollViewer
                                                                        IsVisible="{Binding UseMarkdown}"
                                                                        Markdown="{Binding Content}"
                                                                        Margin="0,4.8,0,0">
                                                                        <mdxaml:MarkdownScrollViewer.Engine>
                                                                            <ex:MarkdownExtension />
                                                                        </mdxaml:MarkdownScrollViewer.Engine>
                                                                        <mdxaml:MarkdownScrollViewer.Styles>
                                                                            <StyleInclude
                                                                                Source="avares://MFAAvalonia/Assets/Style/MdXamlDocStyle.axaml" />
                                                                        </mdxaml:MarkdownScrollViewer.Styles>
                                                                        <mdxaml:MarkdownScrollViewer.Plugins>
                                                                            <StaticResource ResourceKey="MdXamlPlugin" />
                                                                        </mdxaml:MarkdownScrollViewer.Plugins>
                                                                    </mdxaml:MarkdownScrollViewer>
                                                                </DataTemplate>
                                                            </suki:IfConditionConverter.True>
                                                        </suki:IfConditionConverter>
                                                    </Grid.Resources>
                                                    <TextBlock FontSize="12"
                                                               Name="FirstCol"
                                                               Foreground="{DynamicResource SukiDisabledText}"
                                                               Grid.Column="0"
                                                               HorizontalAlignment="Left"
                                                               IsVisible="{Binding ShowTime}"
                                                               Margin="0,5,2,0" MinWidth="55"
                                                               Text="{Binding Time}" TextWrapping="Wrap"
                                                               VerticalAlignment="Top" />
                                                    <ContentControl Grid.Column="1" Content="{Binding}"
                                                                    HorizontalAlignment="Stretch"
                                                                    VerticalAlignment="Top"
                                                                    ContentTemplate="{Binding UseMarkdown,Converter={StaticResource IfConditionConverter}}">
                                                        <ContentControl.MaxWidth>
                                                            <MultiBinding Converter="{converters:MaxWidthConverter}">
                                                                <Binding ElementName="ParentGrid" Path="Bounds.Width" />
                                                                <Binding ElementName="FirstCol" Path="Bounds.Width" />
                                                            </MultiBinding>
                                                        </ContentControl.MaxWidth>
                                                    </ContentControl>
                                                </Grid>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </suki:GroupBox><!-- 折叠时显示的展开按钮 -->
                            <Button Classes="Basic ExpandButton" x:Name="RightExpandButton"
                                    Command="{Binding ToggleRightPanelCommand, Source={x:Static helper:Instances.TaskQueueViewModel}}"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Padding="4"
                                    Width="30" Height="60"
                                    CornerRadius="4"
                                    Opacity="0"
                                    IsVisible="{Binding IsRightPanelCollapsed, Source={x:Static helper:Instances.TaskQueueViewModel}}"
                                    ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.LogRecord}}">
                                <avalonia1:FluentIcon Icon="ChevronLeft" IconSize="Size20" />
                            </Button>
                        </Grid>
                    </suki:GlassCard>
                </Grid>
            </Grid>
        </ScrollViewer>
        <!-- 第二行：三栏布局 -->
        <!-- 竖屏模式下的任务设置 Popup -->
        <Popup x:Name="TaskSettingsPopup"
               IsLightDismissEnabled="True"
               Placement="Center"
               PlacementTarget="{Binding #MainGrid}"
               IsOpen="{Binding IsSettingsPopupOpen, Source={x:Static helper:Instances.TaskQueueViewModel}, Mode=TwoWay}">
            <Border CornerRadius="15"
                    MaxWidth="450"
                    MaxHeight="600"
                    MinWidth="300"
                    Margin="20" Background="{DynamicResource GlassBorderBrush}"
                    BoxShadow="0 8 32 0 #40000000">
                <suki:GlassCard IsAnimated="False" Padding="20">
                    <suki:GlassCard.Resources>
                        <suki:IfConditionConverter x:Key="PopupIfConditionConverter">
                            <suki:IfConditionConverter.True>
                                <Thickness>0,1,0,10</Thickness>
                            </suki:IfConditionConverter.True>
                            <suki:IfConditionConverter.False>
                                <Thickness>0,10,0,10</Thickness>
                            </suki:IfConditionConverter.False>
                        </suki:IfConditionConverter>
                    </suki:GlassCard.Resources>
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <Grid RowDefinitions="Auto,Auto">
                            <suki:GroupBox Grid.Row="0" IsVisible="{Binding HasPopupSettings}"
                                           SeparatorMargin="{Binding ShowSettings, Converter={StaticResource PopupIfConditionConverter}}">
                                <suki:GroupBox.Header>
                                    <DockPanel>
                                        <Button Classes="Basic PanelToggleButton" DockPanel.Dock="Right"
                                                Command="{Binding CloseSettingsPopupCommand, Source={x:Static helper:Instances.TaskQueueViewModel}}"
                                                Padding="2" Margin="0,-5,0,0"
                                                Width="24" Height="24" CornerRadius="4"
                                                ToolTip.Tip="{markup:I18n {x:Static helper:LangKeys.ButtonClose}}">
                                            <avalonia1:FluentIcon Icon="Dismiss" IconSize="Size16" />
                                        </Button>
                                        <TextBlock DockPanel.Dock="Left"
                                                   FontSize="13"
                                                   FontWeight="Bold" Foreground="{DynamicResource SukiText}"
                                                   HorizontalAlignment="Left"
                                                   Margin="2,0,0,0"
                                                   Text="{markup:I18n {x:Static helper:LangKeys.TaskSettings}}"
                                                   VerticalAlignment="Center" />
                                        <StackPanel Margin="10,0,10,5" Orientation="Horizontal"
                                                    HorizontalAlignment="Right"
                                                    DockPanel.Dock="Right"
                                                    IsVisible="{Binding ShowSettings}" Spacing="8">
                                            <RadioButton FontSize="11" FontWeight="Bold"
                                                         Classes="Inner" IsChecked="{Binding IsCommon}"
                                                         GroupName="PopupSettingA">
                                                <TextBlock
                                                    Text="{markup:I18n {x:Static helper:LangKeys.CommonSetting}}" />
                                            </RadioButton>
                                            <RadioButton FontSize="11" FontWeight="Bold" Classes="Inner"
                                                         GroupName="PopupSettingA"
                                                         IsChecked="{calcBinding:Binding '!IsCommon'}">
                                                <TextBlock
                                                    Text="{markup:I18n {x:Static helper:LangKeys.AdvancedSetting}}" />
                                            </RadioButton>
                                        </StackPanel>
                                    </DockPanel>
                                </suki:GroupBox.Header>

                                <Grid>
                                    <StackPanel IsVisible="{calcBinding:Binding 'IsCommon'}"
                                                x:Name="PopupCommonOptionSettings" Orientation="Vertical" />
                                    <StackPanel IsVisible="{calcBinding:Binding '!IsCommon'}"
                                                x:Name="PopupAdvancedOptionSettings" Orientation="Vertical" />
                                </Grid>
                            </suki:GroupBox>
                            <suki:GroupBox Grid.Row="1" Margin="0 10 0 0" IsVisible="{Binding HasPopupIntroduction}">
                                <suki:GroupBox.Header>
                                    <TextBlock FontSize="13" FontWeight="Bold"
                                               Text="{markup:I18n {x:Static helper:LangKeys.TaskDescription}}" />
                                </suki:GroupBox.Header>
                                <ScrollViewer>
                                    <mdxaml:MarkdownScrollViewer x:Name="PopupIntroduction"
                                                                 Markdown="{Binding PopupIntroductionContent}">
                                        <mdxaml:MarkdownScrollViewer.Engine>
                                            <ex:MarkdownExtension />
                                        </mdxaml:MarkdownScrollViewer.Engine>
                                        <mdxaml:MarkdownScrollViewer.Styles>
                                            <StyleInclude
                                                Source="avares://MFAAvalonia/Assets/Style/MdXamlDocStyle.axaml" />
                                        </mdxaml:MarkdownScrollViewer.Styles>
                                        <mdxaml:MarkdownScrollViewer.Plugins>
                                            <StaticResource ResourceKey="MdXamlPlugin" />
                                        </mdxaml:MarkdownScrollViewer.Plugins>
                                    </mdxaml:MarkdownScrollViewer>
                                </ScrollViewer>
                            </suki:GroupBox>
                        </Grid>
                    </ScrollViewer>
                </suki:GlassCard>
            </Border>
        </Popup>
    </Grid>
</UserControl>