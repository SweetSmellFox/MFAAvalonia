using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using MFAAvalonia.Configuration;
using MFAAvalonia.Extensions;
using MFAAvalonia.Extensions.MaaFW;
using MFAAvalonia.Helper;
using MFAAvalonia.Helper.ValueType;
using SukiUI.Dialogs;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;

namespace MFAAvalonia.ViewModels.UsersControls.Settings;

public partial class AddTaskDialogViewModel : ViewModelBase
{
    private ObservableCollection<AddTaskItemViewModel> _items;

    public ObservableCollection<AddTaskItemViewModel> Items
    {
        get => _items;
        set => SetProperty(ref _items, value);
    }

    public List<AddTaskItemViewModel> Sources { get; set; }

    public ObservableCollection<AddTaskItemViewModel> SpecialTasks { get; set; }

    public ISukiDialog Dialog { get; set; }

    public AddTaskDialogViewModel(ISukiDialog dialog, ICollection<DragItemViewModel> sources)
    {
        Dialog = dialog;
        Sources = sources.Select(s => new AddTaskItemViewModel(s)).ToList();
        _items = new ObservableCollection<AddTaskItemViewModel>(Sources);
        SpecialTasks = new ObservableCollection<AddTaskItemViewModel>(CreateSpecialTasks());
    }

    private static List<AddTaskItemViewModel> CreateSpecialTasks()
    {
        return
        [
            new AddTaskItemViewModel { Name = "â³ å€’è®¡æ—¶", IsSpecialTask = true, SpecialActionName = nameof(Extensions.MaaFW.Custom.CountdownAction) },
            new AddTaskItemViewModel { Name = "â° å®šæ—¶ç­‰å¾…", IsSpecialTask = true, SpecialActionName = nameof(Extensions.MaaFW.Custom.TimedWaitAction) },
            new AddTaskItemViewModel { Name = "ðŸ’¬ ç³»ç»Ÿé€šçŸ¥", IsSpecialTask = true, SpecialActionName = nameof(Extensions.MaaFW.Custom.SystemNotificationAction) },
            new AddTaskItemViewModel { Name = "â–¶ è‡ªå®šä¹‰ç¨‹åº", IsSpecialTask = true, SpecialActionName = nameof(Extensions.MaaFW.Custom.CustomProgramAction) },
            new AddTaskItemViewModel { Name = "â›” ç»“æŸè¿›ç¨‹", IsSpecialTask = true, SpecialActionName = nameof(Extensions.MaaFW.Custom.KillProcessAction) },
            new AddTaskItemViewModel { Name = "âš¡ ç”µè„‘æ“ä½œ", IsSpecialTask = true, SpecialActionName = nameof(Extensions.MaaFW.Custom.ComputerOperationAction) },
            new AddTaskItemViewModel { Name = "ðŸ”” Webhook", IsSpecialTask = true, SpecialActionName = nameof(Extensions.MaaFW.Custom.WebhookAction) },
        ];
    }

    [RelayCommand]
    private void Add()
    {
        var vm = Instances.InstanceTabBarViewModel.ActiveTab.TaskQueueViewModel;
        var added = false;

        // æ·»åŠ æ™®é€šä»»åŠ¡
        foreach (var item in Items.Where(i => i.AddCount > 0))
        {
            for (int i = 0; i < item.AddCount; i++)
            {
                if (item.Source == null) continue;
                var output = item.Source.Clone();
                if (output.InterfaceItem.Option != null)
                    output.InterfaceItem.Option.ForEach(option =>
                        TaskLoader.SetDefaultOptionValue(MaaProcessor.Interface, option));
                output.OwnerViewModel = vm;
                vm.TaskItemViewModels.Add(output);
                added = true;
            }
        }

        // æ·»åŠ ç‰¹æ®Šä»»åŠ¡
        foreach (var special in SpecialTasks.Where(s => s.AddCount > 0))
        {
            for (int i = 0; i < special.AddCount; i++)
            {
                var task = new MaaInterface.MaaInterfaceTask
                {
                    Name = special.Name,
                    Entry = special.SpecialActionName ?? "",
                    IsSpecialTask = true,
                };
                var dragItem = new DragItemViewModel(task) { OwnerViewModel = vm };
                vm.TaskItemViewModels.Add(dragItem);
                added = true;
            }
        }

        if (added)
        {
            ConfigurationManager.CurrentInstance.SetValue(ConfigurationKeys.TaskItems,
                vm.TaskItemViewModels.ToList().Select(model => model.InterfaceItem));
            ToastHelper.Info(LangKeys.Tip.ToLocalization(), LangKeys.TaskAddedToast.ToLocalization());
        }

        Dialog.Dismiss();
    }

    [RelayCommand]
    private void Cancel()
    {
        Dialog.Dismiss();
    }
}
