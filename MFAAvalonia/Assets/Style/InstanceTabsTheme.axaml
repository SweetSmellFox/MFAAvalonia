<ResourceDictionary xmlns="https://github.com/avaloniaui"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:controls="clr-namespace:MFAAvalonia.Controls">

    <!-- 下拉展开按钮主题（与 + 按钮同尺寸，GlassCard 半透明背景） -->
    <ControlTheme x:Key="DropdownToggleButton" TargetType="Button">
        <Setter Property="Background" Value="{DynamicResource SukiGlassCardBackground}" />
        <Setter Property="Foreground" Value="{DynamicResource SukiLowText}" />
        <Setter Property="BorderThickness" Value="0" />
        <Setter Property="Width" Value="26" />
        <Setter Property="Height" Value="26" />
        <Setter Property="CornerRadius" Value="{DynamicResource ControlCornerRadius}" />
        <Setter Property="Padding" Value="0" />
        <Setter Property="HorizontalContentAlignment" Value="Center" />
        <Setter Property="VerticalContentAlignment" Value="Center" />
        <Setter Property="Template">
            <ControlTemplate>
                <Grid>
                    <!-- 背景层：GlassCard 同款颜色 + 透明度 -->
                    <Border x:Name="PART_BackgroundBorder"
                            Background="{TemplateBinding Background}"
                            CornerRadius="{TemplateBinding CornerRadius}"
                            Opacity="0.65" />
                    <!-- 内容层 -->
                    <ContentPresenter x:Name="PART_ContentPresenter"
                                      BorderBrush="{TemplateBinding BorderBrush}"
                                      BorderThickness="{TemplateBinding BorderThickness}"
                                      CornerRadius="{TemplateBinding CornerRadius}"
                                      Content="{TemplateBinding Content}"
                                      ContentTemplate="{TemplateBinding ContentTemplate}"
                                      Padding="{TemplateBinding Padding}"
                                      Foreground="{TemplateBinding Foreground}"
                                      HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                                      VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}" />
                </Grid>
            </ControlTemplate>
        </Setter>
        <Style Selector="^:pointerover /template/ Border#PART_BackgroundBorder">
            <Setter Property="Background" Value="{DynamicResource TabBarHoverBackground}" />
            <Setter Property="Opacity" Value="1" />
        </Style>
        <Style Selector="^:pointerover">
            <Setter Property="Foreground" Value="{DynamicResource SukiText}" />
        </Style>
        <Style Selector="^:pressed /template/ Border#PART_BackgroundBorder">
            <Setter Property="Background" Value="{DynamicResource TabBarHoverBackground}" />
            <Setter Property="Opacity" Value="1" />
        </Style>
    </ControlTheme>

    <!-- LeftPressedThumb 主题 -->
    <ControlTheme x:Key="DragTabItemThumb" TargetType="controls:LeftPressedThumb">
        <Setter Property="HorizontalAlignment" Value="Stretch" />
        <Setter Property="VerticalAlignment" Value="Stretch" />
        <Setter Property="IsHitTestVisible" Value="True" />
        <Setter Property="Background" Value="Transparent" />
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate>
                    <Border Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}" />
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </ControlTheme>

    <!-- 关闭按钮主题 -->
    <ControlTheme x:Key="CloseItemCommandButton" TargetType="Button">
        <Setter Property="Width" Value="20" />
        <Setter Property="Height" Value="20" />
        <Setter Property="Background" Value="Transparent" />
        <Setter Property="Foreground" Value="{DynamicResource SukiLowText}" />
        <Setter Property="CornerRadius" Value="10" />
        <Setter Property="Padding" Value="0" />
        <Setter Property="Template">
            <ControlTemplate>
                <Border CornerRadius="{TemplateBinding CornerRadius}"
                        Background="{TemplateBinding Background}"
                        BorderThickness="{TemplateBinding BorderThickness}"
                        BorderBrush="{TemplateBinding BorderBrush}">
                    <Viewbox Width="8" Height="8">
                        <Path Stretch="Uniform"
                              Fill="{TemplateBinding Foreground}"
                              Data="M13.46,12L19,17.54V19H17.54L12,13.46L6.46,19H5V17.54L10.54,12L5,6.46V5H6.46L12,10.54L17.54,5H19V6.46L13.46,12Z" />
                    </Viewbox>
                </Border>
            </ControlTemplate>
        </Setter>
        <Style Selector="^:pointerover">
            <Setter Property="Foreground" Value="{DynamicResource SukiText}" />
            <Setter Property="Background" Value="#20000000" />
        </Style>
        <Style Selector="^:pressed">
            <Setter Property="Background" Value="#30000000" />
        </Style>
    </ControlTheme>

    <!-- + 按钮主题 -->
    <ControlTheme x:Key="AddItemCommandButton" TargetType="Button">
        <Setter Property="Content">
            <Template>
                <Viewbox Width="16" Height="16" Stretch="Uniform">
                    <Canvas Width="24" Height="24">
                        <Path Fill="{Binding $parent[Button].Foreground}"
                              Data="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
                    </Canvas>
                </Viewbox>
            </Template>
        </Setter>
        <Setter Property="Background" Value="Transparent" />
        <Setter Property="Foreground" Value="{DynamicResource SukiLowText}" />
        <Setter Property="BorderThickness" Value="0" />
        <Setter Property="CornerRadius" Value="{DynamicResource ControlCornerRadius}" />
        <Setter Property="Padding" Value="5" />
        <Setter Property="HorizontalAlignment" Value="Center" />
        <Setter Property="VerticalAlignment" Value="Center" />
        <Setter Property="RenderTransform" Value="none" />
        <Setter Property="Transitions">
            <Transitions>
                <TransformOperationsTransition Property="RenderTransform" Duration="0:0:.075" />
            </Transitions>
        </Setter>
        <Setter Property="Template">
            <ControlTemplate>
                <ContentPresenter x:Name="PART_ContentPresenter"
                                  Background="{TemplateBinding Background}"
                                  BorderBrush="{TemplateBinding BorderBrush}"
                                  BorderThickness="{TemplateBinding BorderThickness}"
                                  CornerRadius="{TemplateBinding CornerRadius}"
                                  Content="{TemplateBinding Content}"
                                  ContentTemplate="{TemplateBinding ContentTemplate}"
                                  Padding="{TemplateBinding Padding}"
                                  Foreground="{TemplateBinding Foreground}"
                                  HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                                  VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}" />
            </ControlTemplate>
        </Setter>
        <Style Selector="^:pointerover /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource TabBarHoverBackground}" />
        </Style>
        <Style Selector="^:pressed">
            <Setter Property="RenderTransform" Value="scale(0.98)" />
        </Style>
        <Style Selector="^:pressed /template/ ContentPresenter#PART_ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource TabBarHoverBackground}" />
        </Style>
    </ControlTheme>

    <!-- DragTabItem 主题 -->
    <ControlTheme x:Key="{x:Type controls:DragTabItem}" TargetType="controls:DragTabItem">
        <Setter Property="FontSize" Value="12" />
        <Setter Property="FontWeight" Value="Normal" />
        <Setter Property="Background" Value="Transparent" />
        <Setter Property="Foreground" Value="{DynamicResource SukiLowText}" />
        <Setter Property="Padding" Value="10,6" />
        <Setter Property="Margin" Value="0" />
        <Setter Property="MinHeight" Value="32" />
        <Setter Property="Height" Value="32" />
        <Setter Property="VerticalContentAlignment" Value="Center" />
        <Setter Property="CornerRadius" Value="6,6,0,0" />
        <Setter Property="ClipToBounds" Value="False" />
        <Setter Property="Template">
            <ControlTemplate>
                <Grid ClipToBounds="False">
                <!-- hover 时显示的完整标签形状（含曲线脚，延伸到标签外侧） -->
                <Path Name="PART_TabShape"
                      IsVisible="False"
                      IsHitTestVisible="False" />

                <!-- 标签主体 -->
                <Border Name="PART_LayoutRoot"
                        Background="{TemplateBinding Background}"
                        BorderBrush="{TemplateBinding BorderBrush}"
                        BorderThickness="{TemplateBinding BorderThickness}"
                        CornerRadius="{TemplateBinding CornerRadius}">
                    <Panel>
                        <Panel Margin="{TemplateBinding Padding}">
                            <ContentPresenter Name="PART_ContentPresenter"
                                              Margin="0,0,18,0"
                                              ContentTemplate="{TemplateBinding HeaderTemplate}"
                                              Content="{TemplateBinding Header}"
                                              HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                              TextBlock.FontFamily="{TemplateBinding FontFamily}"
                                              TextBlock.FontSize="{TemplateBinding FontSize}"
                                              TextBlock.FontWeight="{TemplateBinding FontWeight}" />
                        </Panel>

                        <controls:LeftPressedThumb Name="PART_Thumb"
                                                   Theme="{StaticResource DragTabItemThumb}" />
                    </Panel>
                </Border>

                <!-- 关闭按钮：放在外层 Grid，脱离 Thumb 的 Panel，避免事件拦截 -->
                <Button Name="PART_CloseButton"
                        Margin="0,0,8,2"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Center"
                        Theme="{StaticResource CloseItemCommandButton}"
                        Command="{Binding $parent[controls:InstanceTabsControl].CloseItemCommand}"
                        CommandParameter="{ReflectionBinding}" />

                <!-- 右侧分隔线 -->
                <Border Name="PART_RightBorder"
                        Background="{DynamicResource SukiLowText}"
                        Height="16"
                        Width="1"
                        VerticalAlignment="Center"
                        HorizontalAlignment="Right" />
                </Grid>
            </ControlTemplate>
        </Setter>

        <!-- Selected: 透明背景（渐变透出） -->
        <Style Selector="^:selected">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="{DynamicResource SukiPrimaryColor}" />
            <Setter Property="FontWeight" Value="SemiBold" />
        </Style>

        <!-- PointerOver: 显示 PART_TabShape 曲线脚形状 -->
        <Style Selector="^:pointerover /template/ Path#PART_TabShape">
            <Setter Property="IsVisible" Value="True" />
            <Setter Property="Fill" Value="{DynamicResource TabBarHoverBackground}" />
        </Style>
        <Style Selector="^:pointerover">
            <Setter Property="Foreground" Value="{DynamicResource SukiText}" />
        </Style>

        <!-- Selected: 隐藏分隔线 -->
        <Style Selector="^:selected /template/ Border#PART_RightBorder">
            <Setter Property="IsVisible" Value="False" />
        </Style>

        <!-- PointerOver: 隐藏分隔线 -->
        <Style Selector="^:pointerover /template/ Border#PART_RightBorder">
            <Setter Property="IsVisible" Value="False" />
        </Style>

        <!-- Selected: 隐藏 PART_TabShape -->
        <Style Selector="^:selected /template/ Path#PART_TabShape">
            <Setter Property="IsVisible" Value="False" />
        </Style>

        <!-- Selected PointerOver: 保持透明，隐藏 PART_TabShape -->
        <Style Selector="^:selected:pointerover /template/ Path#PART_TabShape">
            <Setter Property="IsVisible" Value="False" />
        </Style>
        <Style Selector="^:selected:pointerover">
            <Setter Property="Foreground" Value="{DynamicResource SukiPrimaryColor}" />
        </Style>
    </ControlTheme>

    <!-- InstanceTabsControl 主题 -->
    <ControlTheme x:Key="{x:Type controls:InstanceTabsControl}" TargetType="controls:InstanceTabsControl">
        <Setter Property="Margin" Value="0" />
        <Setter Property="Padding" Value="0" />
        <Setter Property="Background" Value="Transparent" />
        <Setter Property="AdjacentHeaderItemOffset" Value="-1" />
        <Setter Property="Template">
            <ControlTemplate>
                <Grid>
                    <!-- 标签 + 添加按钮（TabBarBackground 已移至外层 InstanceTabBar 覆盖整个标签栏） -->
                    <StackPanel Orientation="Horizontal">
                        <ItemsPresenter Name="PART_ItemsPresenter"
                                        ItemsPanel="{TemplateBinding ItemsPanel}" />

                        <Button Name="PART_AddItemButton"
                                Command="{Binding AddItemCommand, RelativeSource={RelativeSource TemplatedParent}}"
                                Theme="{StaticResource AddItemCommandButton}"
                                IsVisible="{TemplateBinding ShowDefaultAddButton}"
                                VerticalAlignment="Center"
                                Margin="4,0,8,4" />
                    </StackPanel>
                </Grid>
            </ControlTemplate>
        </Setter>
    </ControlTheme>

</ResourceDictionary>
